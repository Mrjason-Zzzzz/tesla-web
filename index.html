<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tesla Cinema 2.1</title>
    <style>
        /* --- UI æ ·å¼åŒº (ä¿æŒæš—é»‘é£æ ¼) --- */
        body { margin: 0; padding: 0; background-color: #121212; color: #fff; font-family: sans-serif; overflow: hidden; }
        #app { display: flex; flex-direction: column; height: 100vh; }

        .header { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: #fff; font-size: 16px; outline: none; }
        button { padding: 0 20px; border-radius: 8px; border: none; background: #E50914; color: #fff; font-weight: bold; font-size: 15px; cursor: pointer; }
        button:active { opacity: 0.8; }

        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 15px; }
        
        .card { background: #1e1e1e; border-radius: 6px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .poster { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #333; }
        .title { padding: 8px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ddd; }

        /* æ’­æ”¾å™¨å±‚ */
        #player-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none; flex-direction: column;
        }
        
        .iframe-box { flex: 1; width: 100%; position: relative; }
        iframe { width: 100%; height: 100%; border: none; display: block; }

        .controls { height: 35%; background: #121212; padding: 15px; overflow-y: auto; border-top: 1px solid #333; }
        
        .lines-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .line-btn { 
            padding: 6px 12px; background: #333; border-radius: 4px; font-size: 12px; 
            color: #aaa; border: 1px solid #444; cursor: pointer;
        }
        .line-btn.active { background: #E50914; color: #fff; border-color: #E50914; }

        .ep-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .ep-btn { 
            padding: 10px 15px; background: #2c2c2c; border-radius: 4px; font-size: 14px; 
            cursor: pointer; min-width: 50px; text-align: center; border: 1px solid #333;
        }
        .ep-btn.active { background: #fff; color: #000; border-color: #fff; }

        .close-btn { 
            position: absolute; top: 15px; left: 15px; z-index: 200; 
            background: rgba(0,0,0,0.6); padding: 6px 16px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.3); font-size: 13px; cursor: pointer;
        }
        
        .loading { text-align: center; padding: 20px; color: #888; display: none; font-size: 14px; }
        .error-msg { text-align: center; padding: 30px; color: #E50914; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥ç‰‡å..." value="åº†ä½™å¹´">
        <button onclick="doSearch()">æœç´¢</button>
    </div>
    <div class="content">
        <div id="loading" class="loading"></div>
        <div id="videoGrid" class="grid"></div>
    </div>
</div>

<div id="player-layer">
    <div class="close-btn" onclick="closePlayer()">â† è¿”å›</div>
    <div class="iframe-box">
        <iframe id="playFrame" src="" allow="autoplay; encrypted-media; fullscreen" scrolling="no"></iframe>
    </div>
    <div class="controls">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="playTitle" style="margin:0; font-size:16px; color:#fff;">æ­£åœ¨æ’­æ”¾</h3>
            <span style="font-size:12px; color:#666;">è‹¥å¤±è´¥è¯·åˆ‡çº¿è·¯ ğŸ‘‡</span>
        </div>
        <div id="line-box" class="lines-group"></div>
        <div id="episodes" class="ep-list"></div>
    </div>
</div>

<script>
    // --- 1. å¤šä¸ªè§£æçº¿è·¯ (è§£å†³è§†é¢‘åŠ è½½å¤±è´¥) ---
    const PARSERS = [
        { name: "çº¿è·¯1(æ¨è)", url: "https://hhjiexi.com/play/?url=" },
        { name: "çº¿è·¯2(å¤‡ç”¨)", url: "https://jx.xmflv.com/?url=" },
        { name: "çº¿è·¯3(é€šç”¨)", url: "https://jx.aidouer.net/?url=" },
        { name: "çº¿è·¯4(çº¯å‡€)", url: "https://im1907.top/?jx=" }
    ];

    // --- 2. å¤šä¸ªè·¨åŸŸä»£ç†é€šé“ (è§£å†³æœç´¢ä¸å‡ºæ¥) ---
    // å¦‚æœç¬¬1ä¸ªæœä¸å‡ºæ¥ï¼Œä»£ç ä¼šè‡ªåŠ¨è¯•ç¬¬2ä¸ª...
    const PROXY_GATES = [
        "https://api.codetabs.com/v1/proxy?quest=", // é€šé“ A: CodeTabs (é€šå¸¸æœ€ç¨³)
        "https://api.allorigins.win/raw?url=",      // é€šé“ B: AllOrigins
        "https://corsproxy.io/?",                   // é€šé“ C: CORSProxy
    ];

    const API_TARGET = "https://hhzyapi.com/api.php/provide/vod/";
    let currentVideoUrl = "";
    let currentLineIndex = 0;

    // --- æ™ºèƒ½æœç´¢åŠŸèƒ½ ---
    async function doSearch() {
        const wd = document.getElementById('searchInput').value.trim();
        if(!wd) return alert("è¯·è¾“å…¥å…³é”®è¯");

        const grid = document.getElementById('videoGrid');
        const loader = document.getElementById('loading');
        
        grid.innerHTML = '';
        loader.style.display = 'block';
        loader.innerText = "æ­£åœ¨å°è¯•è¿æ¥èµ„æºåº“...";

        // æ„é€ ç›®æ ‡ API åœ°å€
        const targetApiUrl = `${API_TARGET}?ac=detail&wd=${encodeURIComponent(wd)}`;

        // å¾ªç¯å°è¯•æ‰€æœ‰ä»£ç†é€šé“
        let success = false;
        let finalData = null;

        for (let i = 0; i < PROXY_GATES.length; i++) {
            const proxyPrefix = PROXY_GATES[i];
            loader.innerText = `æ­£åœ¨å°è¯•é€šé“ ${i+1}/${PROXY_GATES.length} ...`;
            
            try {
                // å‘èµ·è¯·æ±‚
                const res = await fetch(proxyPrefix + encodeURIComponent(targetApiUrl));
                if (res.ok) {
                    const data = await res.json();
                    if (data && data.list) {
                        finalData = data;
                        success = true;
                        break; // æˆåŠŸäº†ï¼è·³å‡ºå¾ªç¯
                    }
                }
            } catch (e) {
                console.log(`é€šé“ ${i+1} å¤±è´¥:`, e);
                // å¤±è´¥äº†å°±ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯
            }
        }

        loader.style.display = 'none';

        if (!success || !finalData) {
            grid.innerHTML = `
                <div class="error-msg">
                    æœç´¢å¤±è´¥ã€‚<br>
                    æ‰€æœ‰å…¬å…±é€šé“éƒ½è¶…æ—¶äº†ã€‚<br>
                    è¯·ç¨åå†è¯•ï¼Œæˆ–è€…æ£€æŸ¥ç½‘ç»œã€‚
                </div>`;
            return;
        }

        if (finalData.list.length === 0) {
            grid.innerHTML = '<div class="error-msg">æœªæ‰¾åˆ°ç›¸å…³å½±ç‰‡</div>';
            return;
        }

        // æ¸²æŸ“æµ·æŠ¥
        finalData.list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openPlayer(item);
            card.innerHTML = `
                <img class="poster" src="${item.vod_pic}" onerror="this.src='https://via.placeholder.com/150x200?text=No+Img'">
                <div class="title">${item.vod_name}</div>
            `;
            grid.appendChild(card);
        });
    }

    // --- æ’­æ”¾å™¨é€»è¾‘ ---
    function openPlayer(videoData) {
        document.getElementById('player-layer').style.display = 'flex';
        document.getElementById('playTitle').innerText = videoData.vod_name;
        
        renderLines();

        const epDiv = document.getElementById('episodes');
        epDiv.innerHTML = '';
        
        let playUrlStr = videoData.vod_play_url;
        // æ¸…æ´—æ•°æ®ï¼šå¦‚æœæœ‰ $$$ åˆ†éš”ç¬¦ï¼Œå–ç¬¬ä¸€ç»„
        if (playUrlStr.includes('$$$')) {
            playUrlStr = playUrlStr.split('$$$')[0];
        }

        const epList = playUrlStr.split('#').filter(s => s.includes('$'));

        if(epList.length === 0) {
            epDiv.innerHTML = '<div style="color:#666;padding:10px">æš‚æ— èµ„æº</div>';
            return;
        }

        epList.forEach(ep => {
            const [name, url] = ep.split('$');
            const btn = document.createElement('div');
            btn.className = 'ep-btn';
            btn.innerText = name;
            btn.onclick = () => {
                document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentVideoUrl = url;
                playWithCurrentLine();
            };
            epDiv.appendChild(btn);
        });

        if(epList.length > 0) {
            epDiv.firstChild.click();
        }
    }

    function renderLines() {
        const box = document.getElementById('line-box');
        box.innerHTML = '';
        PARSERS.forEach((parser, index) => {
            const btn = document.createElement('div');
            btn.className = `line-btn ${index === currentLineIndex ? 'active' : ''}`;
            btn.innerText = parser.name;
            btn.onclick = () => {
                currentLineIndex = index;
                renderLines();
                playWithCurrentLine();
            };
            box.appendChild(btn);
        });
    }

    function playWithCurrentLine() {
        if (!currentVideoUrl) return;
        const frame = document.getElementById('playFrame');
        const parserPrefix = PARSERS[currentLineIndex].url;
        frame.src = parserPrefix + currentVideoUrl;
    }

    function closePlayer() {
        document.getElementById('player-layer').style.display = 'none';
        document.getElementById('playFrame').src = "";
    }

    window.onload = () => {
        document.getElementById('searchInput').value = 'çƒ­é—¨';
        doSearch();
    }
</script>

</body>
</html>
