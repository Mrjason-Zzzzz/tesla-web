<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Tesla CarPlay - å‰¯é©¾è§‚å½±</title>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="//unpkg.com/xgplayer@2.31.6/browser/index.js"></script>
    <script src="//unpkg.com/xgplayer-hls.js/dist/index.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ç‰¹æ–¯æ‹‰é£æ ¼é»‘é‡‘é…è‰² */
        :root { --primary: #E31937; --bg: #000; --panel: #111; --text: #eee; --border: #222; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Tesla', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        /* å·¦ä¾§ï¼šæºé€‰æ‹© (åŠ å¤§è§¦æ§åŒº) */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 30; }
        .brand { padding: 25px 20px; font-size: 20px; font-weight: 700; letter-spacing: 1px; color: var(--primary); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        
        #group-list { flex: 1; overflow-y: auto; padding: 15px; }
        .group-title { font-size: 12px; color: #666; margin: 10px 5px; font-weight: bold; text-transform: uppercase; }
        
        .nav-item { padding: 16px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; color: #999; display: flex; justify-content: space-between; font-size: 15px; transition: 0.2s; background: rgba(255,255,255,0.02); }
        .nav-item:active { transform: scale(0.98); }
        .nav-item.active { background: rgba(227, 25, 55, 0.15); color: var(--primary); border: 1px solid rgba(227, 25, 55, 0.3); font-weight: bold; }
        .badge { background: #333; padding: 2px 8px; border-radius: 6px; font-size: 12px; color: #aaa; }

        /* ä¸­é—´ï¼šé¢‘é“åˆ—è¡¨ */
        #middle { width: 320px; background: #0a0a0a; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .search_wrap { padding: 20px; border-bottom: 1px solid var(--border); }
        #search { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 14px; border-radius: 10px; font-size: 15px; }
        #search:focus { border-color: var(--primary); }
        
        #channel_list { flex: 1; overflow-y: auto; padding: 10px; }
        .channel_item { display: flex; align-items: center; padding: 14px; margin-bottom: 6px; background: #141414; border-radius: 8px; cursor: pointer; border-left: 3px solid transparent; transition: 0.1s; }
        .channel_item:active { background: #222; }
        .channel_item.active { background: #222; border-left-color: var(--primary); }
        .ch_name { font-size: 15px; font-weight: 500; color: #ddd; }

        /* å³ä¾§ï¼šæ’­æ”¾åŒº */
        #stage { flex: 1; position: relative; background: #000; display: flex; flex-direction: column; }
        #player { width: 100%; height: 100%; }
        
        #status_bar { height: 32px; background: #111; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; border-top: 1px solid #222; gap: 6px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .dot.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        .dot.yellow { background: #ff0; }
        .dot.red { background: #f00; }

        /* å¾…æœºé¡µ */
        #standby { position: absolute; inset: 0; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; bottom: 32px; }
        #qrcode_wrap { padding: 12px; background: #fff; border-radius: 14px; box-shadow: 0 0 30px rgba(227,25,55,0.1); }
        #qrcode_text { margin-top: 15px; color: #666; font-size: 13px; text-align: center; }
        
        /* æ¨¡æ€æ¡† (æ¢æº) */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal_box { background: #111; width: 850px; max-height: 85vh; border-radius: 18px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
        .modal_header { padding: 20px 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; font-size: 17px; font-weight: bold; }
        .source_grid { padding: 25px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 18px; }
        .source_card { background: #1a1a1a; padding: 18px; border-radius: 10px; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .source_card:hover { border-color: var(--primary); background: #222; }
        .tag { display: inline-block; font-size: 10px; background: #000; padding: 3px 6px; border-radius: 4px; color: #888; margin-top: 6px; }

        /* æ‰‹æœºç«¯ */
        #phone { display: none; height: 100vh; background: #111; padding: 20px; color: #fff; text-align: center; }
        @media (max-width: 768px) { #sidebar, #middle { display: none; } #phone { display: block; } }
        
        /* Teslaç‰¹è‰²è£…é¥° */
        .tesla_logo { font-size: 24px; }
        .d_park_warning { position: absolute; top: 20px; right: 20px; background: rgba(227, 25, 55, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 20; }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading_spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* é”™è¯¯ä¿¡æ¯ */
        .error_toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(227, 25, 55, 0.9); color: white; padding: 10px 20px; border-radius: 6px; z-index: 100; font-size: 14px; }
    </style>
</head>
<body>

    <div id="phone">
        <h2 style="color:var(--primary); margin-top: 30px;">ğŸš— ç‰¹æ–¯æ‹‰å‰¯é©¾æŠ•å±</h2>
        <p style="color:#999; margin: 10px 0 20px;">è¯·ç¡®ä¿è½¦è¾†å¤„äºPæ¡£æˆ–é©»è½¦çŠ¶æ€<br>å®‰å…¨ç¬¬ä¸€ï¼Œé©¾é©¶æ—¶è¯·å‹¿æ“ä½œ</p>
        <input type="text" id="urlInput" placeholder="è¾“å…¥ç›´æ’­é“¾æ¥æˆ–è§†é¢‘URL..." style="width:90%;padding:16px;border-radius:10px;border:none;margin:15px 0;background:#222;color:#fff;font-size:16px;">
        <button onclick="send()" style="width:90%;padding:16px;background:var(--primary);color:#fff;font-weight:bold;border:none;border-radius:10px;font-size:16px;">å‘é€åˆ°è½¦æœº</button>
        <p style="color:#666; margin-top: 20px; font-size: 14px;">æ³¨æ„ï¼šä»…åœ¨åœè½¦çŠ¶æ€ä¸‹ä½¿ç”¨</p>
    </div>

    <div id="sidebar">
        <div class="brand"><i class="ph-fill ph-television tesla_logo"></i> Tesla CarPlay</div>
        
        <div id="group_list">
            <div class="group_title">å½“å‰ä¿¡å·æº</div>
            <div class="nav_item active" onclick="toggleModal(true)" id="current_source_btn">
                <span id="cur_source_name">ç‰¹æ–¯æ‹‰ä¸“äº«æº</span>
                <i class="ph-bold ph-swap"></i>
            </div>
            
            <div class="group_title" style="margin-top:25px">ç›´æ’­é¢‘é“</div>
            <div id="category_list"></div>
            
            <div class="group_title" style="margin-top:25px">å¿«æ·åŠŸèƒ½</div>
            <div class="nav_item" onclick="showSafetyNotice()">
                <span>å®‰å…¨é¡»çŸ¥</span>
                <i class="ph-bold ph-shield-check"></i>
            </div>
            <div class="nav_item" onclick="resetConnection()">
                <span>é‡ç½®è¿æ¥</span>
                <i class="ph-bold ph-arrow-clockwise"></i>
            </div>
        </div>
    </div>

    <div id="middle">
        <div class="search_wrap">
            <input type="text" id="search" placeholder="æœç´¢é¢‘é“..." oninput="handleSearch()">
        </div>
        <div id="channel_list"></div>
    </div>

    <div id="stage">
        <div class="d_park_warning">Dæ¡£æ¨¡å¼ - å‰¯é©¾è§‚å½±</div>
        <div id="player"></div>
        
        <div id="standby">
            <div id="qrcode_wrap"><div id="qrcode"></div></div>
            <div id="qrcode_text">å¾®ä¿¡æ‰«ç æŠ•å±<br>å®‰å…¨è§‚å½±ï¼Œå¿«ä¹å‡ºè¡Œ</div>
        </div>

        <div id="status_bar">
            <div class="dot" id="status_dot"></div>
            <span id="status_text">ç‰¹æ–¯æ‹‰å‰¯é©¾è§‚å½±ç³»ç»Ÿå°±ç»ª</span>
        </div>
    </div>

    <div id="modal" onclick="if(event.target.id==='modal')toggleModal(false)">
        <div class="modal_box">
            <div class="modal_header">
                <span>é€‰æ‹©ç›´æ’­æº</span>
                <i class="ph-bold ph-x" style="cursor:pointer" onclick="toggleModal(false)"></i>
            </div>
            <div class="source_grid" id="source_grid"></div>
        </div>
    </div>

    <script>
        // === ğŸš— ç‰¹æ–¯æ‹‰ä¸“ç”¨è½¦æœºé…ç½® ===
        const PROXY = 'https://corsproxy.io/?';

        // === ğŸ“º ç‰¹æ–¯æ‹‰ä¼˜åŒ–ç›´æ’­æº (ç²¾é€‰ç¨³å®šæº) ===
        const DB = [
            { name: "Teslaå®˜æ–¹æ¨è", url: "https://gh.aptv.app/https://raw.githubusercontent.com/Kimentanm/aptv/master/m3u/iptv.m3u", desc: "ç‰¹æ–¯æ‹‰ä¼˜é€‰ï¼Œç¨³å®šæµç•…", tag: "å®˜æ–¹æ¨è" },
            { name: "é«˜æ¸…ä½“è‚²é¢‘é“", url: "https://raw.githubusercontent.com/Fairy8o/IPTV/main/PDX-V6.txt", desc: "ä½“è‚²èµ›äº‹ç›´æ’­ä¸“çº¿", tag: "ä½“è‚²" },
            { name: "å¤®è§†å«è§†åˆé›†", url: "https://raw.githubusercontent.com/youshandefeiyang/IPTV/main/main/ys.m3u", desc: "å¤®è§†å«è§†å®Œæ•´é¢‘é“", tag: "ç»¼åˆ" },
            { name: "4Kè¶…æ¸…é¢‘é“", url: "https://raw.githubusercontent.com/joevess/IPTV/main/iptv_4k.m3u8", desc: "4Kè¶…æ¸…ç”»è´¨ä½“éªŒ", tag: "4K" },
            { name: "å½±è§†è½®æ’­å°", url: "https://raw.githubusercontent.com/xyxtv/xyxmain/main/ysc.txt", desc: "ç”µå½±ç”µè§†å‰§è½®æ’­", tag: "å½±è§†" },
            { name: "éŸ³ä¹ç”µå°", url: "https://raw.githubusercontent.com/Fairy8o/IPTV/main/Radio/Radio.m3u", desc: "åœ¨çº¿éŸ³ä¹ç”µå°", tag: "éŸ³ä¹" }
        ];

        let player = null;
        let allChannels = [];
        let currentGroup = "å…¨éƒ¨";
        let mqttClient = null;
        let isConnected = false;

        // === åˆå§‹åŒ– ===
        const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
        const getUuid = () => Math.random().toString(36).substring(2, 9);
        const channelId = new URLSearchParams(location.search).get('id') || getUuid();
        const topic = `tesla/carplay/${channelId}`;

        if (new URLSearchParams(location.search).get('mode') === 'sender') {
            document.getElementById('phone').style.display = 'block';
            initMqtt();
        } else {
            initCar();
        }

        function initCar() {
            // ç”Ÿæˆç‰¹æ‹‰æ–¯æŠ•å±äºŒç»´ç 
            const url = `${location.origin}${location.pathname}?mode=sender&id=${channelId}`;
            new QRCode(document.getElementById("qrcode"), { 
                text: url, 
                width: 180, 
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // æ¸²æŸ“ç‰¹æ–¯æ‹‰ä¸“å±æºåˆ—è¡¨
            const grid = document.getElementById('source_grid');
            DB.forEach(src => {
                const div = document.createElement('div');
                div.className = 'source_card';
                div.innerHTML = `
                    <div style="font-weight:bold;color:#fff;font-size:15px">${src.name}</div>
                    <div style="font-size:12px;color:#666;margin-top:5px">${src.desc}</div>
                    <span class="tag">${src.tag}</span>
                `;
                div.onclick = () => loadSource(src);
                grid.appendChild(div);
            });

            // é»˜è®¤åŠ è½½ç‰¹æ–¯æ‹‰æ¨èæº
            loadSource(DB[0]);
            initMqtt();
            
            // æ˜¾ç¤ºå®‰å…¨æç¤º
            setTimeout(() => {
                showSafetyNotice(true);
            }, 3000);
        }

        // === æ ¸å¿ƒåŠ è½½é€»è¾‘ (ç‰¹æ–¯æ‹‰ä¼˜åŒ–ç‰ˆ) ===
        async function loadSource(src) {
            toggleModal(false);
            document.getElementById('cur_source_name').innerText = src.name;
            setStatus('yellow', 'ç‰¹æ–¯æ‹‰æ­£åœ¨è·å–é¢‘é“åˆ—è¡¨...');
            document.getElementById('channel_list').innerHTML = '';
            document.getElementById('category_list').innerHTML = '';

            try {
                // ç‰¹æ–¯æ‹‰æ™ºèƒ½ä»£ç†ï¼šé’ˆå¯¹ä¸åŒæºç±»å‹ä¼˜åŒ–
                let reqUrl = src.url;
                if (reqUrl.includes('github') || reqUrl.includes('raw.githubusercontent')) {
                    reqUrl = PROXY + encodeURIComponent(reqUrl);
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶
                
                const res = await fetch(reqUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const text = await res.text();
                parseM3U(text);
                setStatus('green', `ç‰¹æ–¯æ‹‰å·²åŠ è½½ ${allChannels.length} ä¸ªé¢‘é“`);
            } catch (e) {
                setStatus('red', 'åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–æº');
                console.error('Source loading error:', e);
                showError('ç›´æ’­æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢æº');
            }
        }

        function parseM3U(text) {
            allChannels = [];
            const lines = text.split('\n');
            let info = null;
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF')) {
                    // è§£ææ‰©å±•ä¿¡æ¯
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const tvgNameMatch = line.match(/tvg-name="([^"]*)"/);
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    
                    const group = groupMatch ? groupMatch[1] : 'å…¶ä»–';
                    const name = tvgNameMatch ? tvgNameMatch[1] : line.split(',').pop().trim();
                    
                    info = { 
                        name: name || line.split(',').pop().trim(),
                        group: group,
                        logo: logoMatch ? logoMatch[1] : ''
                    };
                } else if (line && !line.startsWith('#') && info) {
                    allChannels.push({...info, url: line});
                    info = null;
                }
            });
            renderCategories();
        }

        function renderCategories() {
            const groups = {};
            allChannels.forEach(c => groups[c.group] = (groups[c.group]||0)+1);
            const list = document.getElementById('category_list');
            list.innerHTML = '';

            // ç‰¹æ–¯æ‹‰æ™ºèƒ½æ’åº
            const keys = Object.keys(groups).sort((a,b) => {
                if(a.includes('å¤®è§†') || a.includes('CCTV') || a.includes('ä¸­å¤®')) return -1;
                if(b.includes('å¤®è§†') || b.includes('CCTV') || b.includes('ä¸­å¤®')) return 1;
                if(a.includes('å«') && !b.includes('å«')) return -1;
                if(b.includes('å«') && !a.includes('å«')) return 1;
                return a.localeCompare(b);
            });

            // å…¨éƒ¨æŒ‰é’®
            createNavBtn('å…¨éƒ¨é¢‘é“', allChannels.length, 'å…¨éƒ¨');

            keys.forEach(k => createNavBtn(k, groups[k], k));
            
            // é»˜è®¤é€‰ä¸­å…¨éƒ¨
            switchGroup('å…¨éƒ¨');
        }

        function createNavBtn(name, count, id) {
            const div = document.createElement('div');
            div.className = 'nav_item';
            div.innerHTML = `<span>${name}</span><span class="badge">${count}</span>`;
            div.onclick = (e) => {
                document.querySelectorAll('.nav_item').forEach(i=>i.classList.remove('active'));
                e.currentTarget.classList.add('active');
                switchGroup(id);
            };
            if(id === 'å…¨éƒ¨') div.classList.add('active');
            document.getElementById('category_list').appendChild(div);
        }

        function switchGroup(group) {
            currentGroup = group;
            const list = group==='å…¨éƒ¨' ? allChannels : allChannels.filter(c=>c.group===group);
            renderChannels(list);
            document.getElementById('search').value = '';
        }

        function renderChannels(list) {
            const el = document.getElementById('channel_list');
            el.innerHTML = '';
            // ç‰¹æ–¯æ‹‰æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶æ˜¾ç¤ºæ•°é‡
            const displayList = list.slice(0, 120);
            displayList.forEach(c => {
                const div = document.createElement('div');
                div.className = 'channel_item';
                div.innerHTML = `<div class="ch_name">${c.name}</div>`;
                div.onclick = () => play(c.url);
                el.appendChild(div);
            });
        }

        function handleSearch() {
            const val = document.getElementById('search').value.toLowerCase();
            if(!val) return switchGroup(currentGroup);
            const res = allChannels.filter(c => 
                c.name.toLowerCase().includes(val) || 
                c.group.toLowerCase().includes(val)
            );
            renderChannels(res);
        }

        // === ğŸ¬ ç‰¹æ–¯æ‹‰è½¦æœºæ’­æ”¾æ ¸å¿ƒ ===
        function play(url) {
            document.getElementById('standby').style.display = 'none';
            setStatus('yellow', 'ç‰¹æ–¯æ‹‰æ­£åœ¨å»ºç«‹è¿æ¥...');

            // ç‰¹æ–¯æ‹‰å®‰å…¨æ£€æŸ¥ï¼šHTTPS/HTTPæ··åˆå†…å®¹å¤„ç†
            if (location.protocol === 'https:' && url.startsWith('http:')) {
                console.log("Tesla Auto-Proxying insecure stream...");
                url = PROXY + encodeURIComponent(url);
            }

            if (!player) {
                player = new Player({
                    id: 'player',
                    url: url,
                    autoplay: true,
                    muted: true, // ç‰¹æ–¯æ‹‰é»˜è®¤é™éŸ³å¯åŠ¨
                    playsinline: true,
                    fluid: true,
                    videoAttributes: {
                        webkit-playsinline: true,
                        playsInline: true,
                        crossOrigin: 'anonymous'
                    },
                    plugins: [window.HlsJsPlugin],
                    cssFullscreen: true,
                    width: '100%',
                    height: '100%',
                    // ç‰¹æ–¯æ‹‰ä¼˜åŒ–å‚æ•°
                    playbackRate: [0.5, 0.75, 1, 1.25, 1.5, 2],
                    lang: 'zh-cn',
                    whitelist: ['*'],
                    volume: 0.8
                });

                player.on('ready', () => {
                    setStatus('green', 'ç‰¹æ–¯æ‹‰æ’­æ”¾ä¸­');
                    // å®‰å…¨å»¶æ—¶è§£é™¤é™éŸ³
                    setTimeout(() => { 
                        player.muted = false; 
                        player.volume = 0.7; 
                    }, 2000);
                });

                player.on('error', (err) => {
                    setStatus('red', 'æ’­æ”¾å¤±è´¥ - æ£€æŸ¥é“¾æ¥');
                    console.error('Tesla player error:', err);
                    showError('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§');
                });
                
                player.on('waiting', () => {
                    setStatus('yellow', 'ç‰¹æ–¯æ‹‰ç¼“å†²ä¸­...');
                });
                
                player.on('playing', () => {
                    setStatus('green', 'ç‰¹æ–¯æ‹‰æ’­æ”¾ä¸­');
                });
                
                player.on('pause', () => {
                    setStatus('yellow', 'å·²æš‚åœ');
                });
                
                player.once('play', () => {
                    player.getCssFullscreen();
                });

            } else {
                // åˆ‡æ¢é¢‘é“
                player.src = url;
                player.muted = true; // åˆ‡å°æ—¶å…ˆé™éŸ³
                player.play().then(() => {
                    setTimeout(() => { 
                        player.muted = false; 
                        player.volume = 0.7; 
                    }, 1500);
                }).catch(err => {
                    setStatus('red', 'æ’­æ”¾å¤±è´¥ - æ£€æŸ¥é“¾æ¥');
                    console.error('Channel change error:', err);
                    showError('é¢‘é“åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }

        function setStatus(color, text) {
            document.getElementById('status_dot').className = `dot ${color}`;
            document.getElementById('status_text').innerText = text;
        }

        function toggleModal(show) { 
            document.getElementById('modal').style.display = show ? 'flex' : 'none'; 
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error_toast';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }
        
        function showSafetyNotice(firstTime = false) {
            if (firstTime) {
                alert("âš ï¸ å®‰å…¨æé†’ï¼š\n\næ­¤åŠŸèƒ½ä»…ä¾›å‰¯é©¾é©¶ä¹˜å®¢åœ¨è½¦è¾†åœç¨³åä½¿ç”¨\né©¾é©¶å‘˜è¯·ä¸“æ³¨äºé©¾é©¶ï¼Œåˆ‡å‹¿åˆ†å¿ƒè§‚çœ‹è§†é¢‘\n\nç¥æ‚¨æ—…é€”æ„‰å¿«ï¼");
            } else {
                alert("è¯·ç¡®ä¿è½¦è¾†å¤„äºPæ¡£æˆ–å®Œå…¨åœç¨³çŠ¶æ€\nå®‰å…¨è§‚å½±ï¼Œå¿«ä¹å‡ºè¡Œï¼");
            }
        }
        
        function resetConnection() {
            if (mqttClient) {
                mqttClient.end(true);
                isConnected = false;
                setStatus('yellow', 'è¿æ¥å·²é‡ç½®');
                setTimeout(() => {
                    initMqtt();
                }, 1000);
            }
        }

        function initMqtt() {
            try {
                setStatus('yellow', 'ç‰¹æ–¯æ‹‰è¿æ¥ä¸­...');
                
                // MQTTè¿æ¥é€‰é¡¹
                const options = {
                    clientId: `tesla_carplay_${getUuid()}`,
                    clean: true,
                    connectTimeout: 10000,
                    reconnectPeriod: 3000,
                    will: {
                        topic: topic,
                        payload: 'disconnected',
                        qos: 0,
                        retain: false
                    }
                };

                mqttClient = mqtt.connect(mqttBroker, options);
                
                mqttClient.on('connect', () => {
                    isConnected = true;
                    console.log('Tesla MQTT connected');
                    mqttClient.subscribe(topic, { qos: 0 }, (err) => {
                        if (err) {
                            console.error('Tesla subscribe error:', err);
                            setStatus('red', 'è®¢é˜…å¤±è´¥');
                        } else {
                            console.log('Tesla subscribed to:', topic);
                            setStatus('green', 'ç‰¹æ–¯æ‹‰è¿æ¥å°±ç»ª');
                        }
                    });
                    
                    if(new URLSearchParams(location.search).get('mode') === 'sender') {
                        setStatus('green', 'å·²è¿æ¥ç‰¹æ–¯æ‹‰è½¦æœº');
                    }
                });
                
                mqttClient.on('message', (t, m) => {
                    const url = m.toString();
                    console.log('Tesla received URL:', url);
                    if (url !== 'disconnected') {
                        play(url);
                    }
                });
                
                mqttClient.on('error', (err) => {
                    console.error('Tesla MQTT error:', err);
                    setStatus('red', 'è¿æ¥é”™è¯¯');
                    isConnected = false;
                });
                
                mqttClient.on('close', () => {
                    console.log('Tesla MQTT connection closed');
                    if (isConnected) {
                        setStatus('red', 'è¿æ¥æ–­å¼€ - æ­£åœ¨é‡è¿');
                        isConnected = false;
                    }
                });
                
                // æ‰‹æœºç«¯å‘é€å‡½æ•°
                window.send = () => {
                    const input = document.getElementById('urlInput');
                    const url = input.value.trim();
                    
                    if (!url) {
                        showError('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥');
                        return;
                    }
                    
                    // ç®€å•URLéªŒè¯
                    try {
                        new URL(url);
                    } catch (e) {
                        showError('è¯·è¾“å…¥æ­£ç¡®çš„URLæ ¼å¼');
                        return;
                    }
                    
                    if (mqttClient && mqttClient.connected) {
                        mqttClient.publish(topic, url, { qos: 0 }, (err) => {
                            if(err) {
                                console.error('Tesla publish error:', err);
                                showError('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                            } else {
                                input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                                setStatus('green', 'å·²å‘é€åˆ°ç‰¹æ–¯æ‹‰è½¦æœº');
                                setTimeout(() => setStatus('green', 'ç‰¹æ–¯æ‹‰è¿æ¥å°±ç»ª'), 2500);
                            }
                        });
                    } else {
                        showError('æœªè¿æ¥åˆ°ç‰¹æ–¯æ‹‰è½¦æœº');
                    }
                }
            } catch (e) {
                console.error('Tesla MQTT initialization failed:', e);
                setStatus('red', 'åˆå§‹åŒ–å¤±è´¥');
                showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (mqttClient) {
                mqttClient.end(true);
            }
            if (player) {
                player.destroy();
            }
        });
        
        // Dæ¡£æç¤º
        console.log("Tesla CarPlay System Active - D Gear Mode");
        console.log("ID:", channelId);
    </script>
</body>
</html>



