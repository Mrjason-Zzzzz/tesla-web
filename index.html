<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LGCXS PRO 2026</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="//unpkg.com/xgplayer@2.31.6/browser/index.js"></script>
    <script src="//unpkg.com/xgplayer-hls.js/dist/index.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-root: #000000;
            --bg-sidebar: #121212;
            --bg-list: #1e1e1e;
            --primary: #007aff; /* ææ°ªè“/å®é©¬è“é£æ ¼ */
            --accent: #ff3b30;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --border: #333;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-root); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", sans-serif; height: 100vh; overflow: hidden; display: flex; }

        /* === 1. å·¦ä¾§å¯¼èˆª (æº+åˆ†ç»„) === */
        #sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 30;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .brand-area {
            padding: 25px 20px; font-size: 20px; font-weight: 800; letter-spacing: 1px;
            background: linear-gradient(90deg, #007aff, #00c6ff); -webkit-background-clip: text; color: transparent;
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border);
        }

        .source-selector { padding: 15px; border-bottom: 1px solid var(--border); }
        #source-btn {
            width: 100%; background: #2c2c2e; color: #fff; border: 1px solid #3a3a3c;
            padding: 14px; border-radius: 10px; font-size: 14px; font-weight: 600;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        #source-btn:active { background: #3a3a3c; transform: scale(0.98); }

        #group-list { flex: 1; overflow-y: auto; padding: 10px; }
        .group-label { font-size: 12px; color: #666; margin: 15px 10px 5px; font-weight: bold; }
        
        .group-item {
            padding: 14px 15px; margin-bottom: 4px; border-radius: 8px; cursor: pointer;
            color: var(--text-muted); font-size: 15px; display: flex; justify-content: space-between;
            transition: 0.2s;
        }
        .group-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .group-item.active { background: var(--primary); color: #fff; font-weight: bold; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 11px; }

        /* === 2. ä¸­é—´åˆ—è¡¨ (æœç´¢+é¢‘é“) === */
        #middle-panel {
            width: 300px; background: var(--bg-list); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: width 0.3s;
        }

        .search-area { padding: 15px; border-bottom: 1px solid var(--border); }
        .search-input-wrap {
            position: relative; background: #2c2c2e; border-radius: 10px; display: flex; align-items: center;
            border: 1px solid transparent; transition: 0.2s;
        }
        .search-input-wrap:focus-within { border-color: var(--primary); background: #000; }
        .search-icon { padding-left: 12px; color: var(--text-muted); }
        #search-input {
            width: 100%; background: transparent; border: none; color: #fff;
            padding: 14px 10px; font-size: 15px;
        }

        #channel-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .channel-card {
            display: flex; align-items: center; padding: 14px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); border-radius: 10px; cursor: pointer;
            transition: 0.2s; border-left: 4px solid transparent;
        }
        .channel-card:hover { background: rgba(255,255,255,0.08); }
        .channel-card.active { background: #333; border-left-color: var(--primary); }
        
        .ch-logo { 
            width: 44px; height: 44px; border-radius: 8px; background: #000; 
            object-fit: contain; margin-right: 14px; flex-shrink: 0; 
            border: 1px solid #333;
        }
        .ch-info { overflow: hidden; flex: 1; }
        .ch-name { font-size: 15px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; }
        .ch-epg { font-size: 12px; color: #666; margin-top: 4px; }

        /* === 3. å³ä¾§èˆå° === */
        #stage { flex: 1; position: relative; background: #000; }
        #player { width: 100%; height: 100%; }

        /* å¾…æœºå± */
        #standby-screen {
            position: absolute; inset: 0;
            background: radial-gradient(circle at center, #1c1c1e 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        #qrcode-wrap { padding: 15px; background: #fff; border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .standby-info { text-align: center; margin-top: 30px; opacity: 0.8; }
        .standby-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .capsule { 
            display: inline-flex; align-items: center; gap: 6px; 
            background: rgba(255,255,255,0.1); padding: 6px 16px; 
            border-radius: 20px; font-size: 13px; color: #bbb; 
        }

        /* æ‚¬æµ®å·¥å…·æ  */
        .float-bar {
            position: absolute; bottom: 30px; right: 30px;
            display: flex; gap: 15px; z-index: 50;
        }
        .float-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(30,30,30,0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff; font-size: 22px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .float-btn:active { transform: scale(0.9); background: var(--primary); }

        /* æ¨¡æ€æ¡† (æ¢æº) */
        #modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 100; backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1c1c1e; width: 900px; height: 85vh;
            border-radius: 20px; border: 1px solid #333;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-header { 
            padding: 20px 30px; border-bottom: 1px solid #333; background: #252527;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 20px; font-weight: bold; color: #fff; }
        .modal-close { cursor: pointer; font-size: 24px; color: #888; }
        
        .modal-body { flex: 1; overflow-y: auto; padding: 30px; }
        
        .section-title { 
            font-size: 14px; color: var(--primary); font-weight: bold; 
            margin-bottom: 15px; margin-top: 10px; display: flex; align-items: center; gap: 8px;
        }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #333; }
        
        .source-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 15px; margin-bottom: 30px; 
        }
        
        .source-card {
            background: #2c2c2e; padding: 16px; border-radius: 12px;
            cursor: pointer; border: 1px solid transparent;
            display: flex; align-items: flex-start; gap: 12px; transition: 0.2s;
        }
        .source-card:hover { background: #3a3a3c; border-color: #555; transform: translateY(-2px); }
        .source-card.active { border-color: var(--primary); background: rgba(0,122,255,0.1); }
        
        .s-icon { 
            width: 40px; height: 40px; border-radius: 8px; 
            background: linear-gradient(135deg, #333, #222); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; color: #fff; flex-shrink: 0;
        }
        .s-content h4 { margin: 0 0 4px 0; font-size: 15px; color: #eee; }
        .s-content p { margin: 0; font-size: 12px; color: #888; line-height: 1.4; }
        .tag { font-size: 10px; padding: 2px 6px; background: #000; border-radius: 4px; color: #aaa; margin-top: 6px; display: inline-block; }

        /* æ‰‹æœºç«¯ */
        #phone-remote { display: none; height: 100vh; background: #f2f2f7; padding: 20px; color: #000; }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            #sidebar { width: 200px; }
            #middle-panel { width: 240px; }
        }
        @media (max-width: 768px) {
            #sidebar, #middle-panel { display: none; } 
        }
    </style>
</head>
<body>

    <div id="phone-remote">
        <h2>ğŸ“² LGCXS è½¦è½½é¥æ§</h2>
        <div style="background:#fff; padding:20px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.08);">
            <p style="font-size:13px; color:#888; margin-bottom:10px;">æ”¯æŒ M3U8 ç›´æ’­æºæˆ– MP4 é“¾æ¥</p>
            <input type="text" id="urlInput" placeholder="åœ¨æ­¤é•¿æŒ‰ç²˜è´´é“¾æ¥..." style="width:100%; padding:16px; border:1px solid #e5e5ea; border-radius:10px; margin-bottom:15px; box-sizing:border-box; background:#f9f9f9;">
            <button onclick="sendVideo()" style="width:100%; padding:16px; background:var(--primary); color:#fff; border:none; border-radius:10px; font-size:17px; font-weight:bold;">ç«‹å³æŠ•å±</button>
            <p id="phone-status" style="margin-top:20px; color:#34c759; text-align:center; font-weight:bold;">âœ… å·²è¿æ¥åˆ°è½¦è¾†</p>
        </div>
    </div>

    <div id="sidebar">
        <div class="brand-area">
            <i class="ph-fill ph-car-profile"></i> LGCXS 2026
        </div>
        <div class="source-selector">
            <button id="source-btn" onclick="toggleModal(true)">
                <div style="display:flex; flex-direction:column; align-items:flex-start; overflow:hidden;">
                    <span style="font-size:10px; color:#888; margin-bottom:2px;">å½“å‰ä¿¡å·æº</span>
                    <span id="current-source-label" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;">æœªé€‰æ‹©</span>
                </div>
                <i class="ph-bold ph-caret-down"></i>
            </button>
        </div>
        <div id="group-list">
            <div style="padding:20px; text-align:center; color:#444; font-size:12px;">æ­£åœ¨åˆå§‹åŒ–...</div>
        </div>
    </div>

    <div id="middle-panel">
        <div class="search-area">
            <div class="search-input-wrap">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" id="search-input" placeholder="æœå¤®è§†/å«è§†/å‘¨æ˜Ÿé©°..." oninput="handleSearch()">
            </div>
        </div>
        <div id="channel-list">
            </div>
    </div>

    <div id="stage">
        <div id="player"></div>
        
        <div id="standby-screen">
            <div id="qrcode-wrap"><div id="qrcode"></div></div>
            <div class="standby-info">
                <div class="standby-title">å‡†å¤‡å°±ç»ª</div>
                <div class="capsule"><i class="ph-fill ph-qr-code"></i> å¾®ä¿¡æ‰«ç æŠ•å±</div>
                <div class="capsule"><i class="ph-fill ph-list-dashes"></i> å·¦ä¾§é€‰æ‹©é¢‘é“</div>
            </div>
        </div>

        <div class="float-bar">
            <div class="float-btn" onclick="toggleStandby()" title="æ˜¾éšäºŒç»´ç "><i class="ph-bold ph-qr-code"></i></div>
            <div class="float-btn" onclick="toggleModal(true)" title="æ›´æ¢ç›´æ’­æº" style="background:var(--primary);"><i class="ph-bold ph-swap"></i></div>
        </div>
    </div>

    <div id="modal-overlay" onclick="handleModalClick(event)">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">åª’ä½“èµ„æºåº“ (2026ç‰ˆ)</div>
                <div class="modal-close" onclick="toggleModal(false)"><i class="ph-bold ph-x"></i></div>
            </div>
            <div class="modal-body" id="source-grid">
                </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ“š ç»ˆæèµ„æºæ•°æ®åº“ (åˆ†ç±»æ¸…æ´—ç‰ˆ)
        // ==========================================
        const CORS_PROXY = 'https://cors.isteed.cc/';
        
        const RESOURCE_DB = [
            {
                title: "ğŸ† ç²¾é€‰èšåˆ (ç¨³å®šæ¨è)",
                sources: [
                    { name: "IPTV 520ç²¾é€‰", url: "https://gitee.com/bighello/iptv2024/raw/master/all520.m3u", desc: "ç»¼åˆæ€§å¼ºï¼ŒåŒ…å«å¤®è§†å«è§†", tag: "Giteeæº" },
                    { name: "BigBigGrandG èšåˆ", url: "https://raw.githubusercontent.com/BigBigGrandG/IPTV-URL/release/Gather.m3u", desc: "å¤§æ‚çƒ©ï¼Œé¢‘é“æå¤š", tag: "Github" },
                    { name: "AutoIPTV é…’åº—æº", url: "https://mirror.ghproxy.com/https://raw.githubusercontent.com/cymz6/AutoIPTV-Hotel/main/lives.m3u", desc: "é…’åº—æºé‡‡é›†ï¼Œé€Ÿåº¦å¿«", tag: "ç¨³å®š" }
                ]
            },
            {
                title: "ğŸ“º å¹³å°ç›´æ’­ & è½®æ’­",
                sources: [
                    { name: "ç›´æ’­ç†ŠçŒ«", url: "https://gitee.com/bighello/iptv2024/raw/master/panda.m3u", desc: "ç†ŠçŒ«IPTVé‡‡é›†", tag: "Gitee" },
                    { name: "è™ç‰™ä¸€èµ·çœ‹", url: "https://live.freetv.top/huyayqk.m3u", desc: "ç”µå½±/ç”µè§†å‰§/ç»¼è‰º24h", tag: "å½±è§†" },
                    { name: "æ–—é±¼ä¸€èµ·çœ‹", url: "https://live.freetv.top/douyuyqk.m3u", desc: "ç»å…¸è€ç‰‡è½®æ’­", tag: "å½±è§†" },
                    { name: "BiliBili ç›´æ’­", url: "https://www.goodiptv.club/bililive.m3u", desc: "Bç«™UPä¸»ç›´æ’­æµ", tag: "å¨±ä¹" },
                    { name: "è½®æ’­: åæ•°/CIBN", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E8%BD%AE%E6%92%AD_%E5%8D%8E%E6%95%B0.NewTV.SiTV.CIBN.m3u", desc: "æ•°å­—ç”µè§†è½®æ’­é¢‘é“", tag: "NewTV" }
                ]
            },
            {
                title: "ğŸ“¡ ä¼ ç»Ÿç”µè§† (å›½å†…)",
                sources: [
                    { name: "å›½å†…ç”µè§†å° (2022)", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%9B%BD%E5%86%85%E7%94%B5%E8%A7%86%E5%8F%B02022-11.m3u", desc: "å¤®è§†/å«è§†/åœ°æ–¹å°å¤‡ä»½", tag: "å¤‡ä»½" },
                    { name: "å®‰å¾½å†œå¤§æ ¡å›­ç½‘", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%AE%89%E5%BE%BD%E5%86%9C%E5%A4%A72021.m3u", desc: "æ ¡å›­ç½‘IPV6é‡‡é›†", tag: "IPV6" }
                ]
            },
            {
                title: "ğŸŒ å…¨çƒ & æ¸¯æ¾³å°",
                sources: [
                    { name: "æ¸¯æ¾³å°ç›´è¿", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%8F%B0%E6%B9%BE%E9%A6%99%E6%B8%AF%E6%BE%B3%E9%97%A82022-11.m3u", desc: "éƒ¨åˆ†çº¿è·¯å¯èƒ½éœ€ç‰¹æ®Šç½‘ç»œ", tag: "åŒºåŸŸ" },
                    { name: "å›½å¤–ç”µè§†å°", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%9B%BD%E5%A4%96%E7%94%B5%E8%A7%86%E5%8F%B02022-11.m3u", desc: "æ—¥éŸ©æ¬§ç¾é¢‘é“", tag: "å›½é™…" }
                ]
            },
            {
                title: "âš¡ IPv6 ä¸“åŒº",
                sources: [
                    { name: "ç²¾é€‰ IPv6 æº", url: "https://mirror.ghproxy.com/https://raw.githubusercontent.com/Ftindy/IPTV-URL/main/IPV6.m3u", desc: "é€Ÿåº¦æå¿«ï¼Œéœ€è½¦æœºæ”¯æŒIPv6", tag: "æé€Ÿ" }
                ]
            },
            {
                title: "ğŸ“» å¹¿æ’­ & æ™¯åŒº",
                sources: [
                    { name: "å…¨å›½å¹¿æ’­ç”µå°", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%B9%BF%E6%92%AD%E7%94%B5%E5%8F%B02021.m3u", desc: "800+ å¹¿æ’­ç”µå°", tag: "å¬ä¹¦" },
                    { name: "æ™¯åŒºç›´æ’­", url: "https://raw.githubusercontent.com/imDazui/Tvlist-awesome-m3u-m3u8/master/m3u/%E5%B9%BF%E6%92%AD%E7%94%B5%E5%8F%B02021.m3u", desc: "å„åœ°é£æ™¯æ…¢ç›´æ’­", tag: "é£æ™¯" }
                ]
            }
        ];

        // ==========================================
        // ğŸ§  æ ¸å¿ƒå¼•æ“
        // ==========================================
        const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
        const getUuid = () => Math.random().toString(36).substring(2, 9);
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        const channelId = params.get('id') || getUuid();
        const topic = `lgcxs/car/${channelId}`;

        let client = null, player = null;
        let allChannels = []; 
        let currentGroup = "å…¨éƒ¨";

        // å…¥å£åˆ†æµ
        if (mode === 'sender') {
            initPhone();
        } else {
            initCar();
        }

        function initCar() {
            // ç”ŸæˆäºŒç»´ç 
            const remoteUrl = `${window.location.origin}${window.location.pathname}?mode=sender&id=${channelId}`;
            new QRCode(document.getElementById("qrcode"), { text: remoteUrl, width: 180, height: 180 });

            // æ¸²æŸ“èµ„æºåº“
            renderResourceLib();
            
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªæº (520ä¸ª)
            loadSource(RESOURCE_DB[0].sources[0]);

            // MQTTè¿æ¥
            client = mqtt.connect(mqttBroker);
            client.on('connect', () => client.subscribe(topic));
            client.on('message', (t, msg) => play(msg.toString()));
        }

        // æ¸²æŸ“èµ„æºåº“æ¨¡æ€æ¡†
        function renderResourceLib() {
            const grid = document.getElementById('source-grid');
            grid.innerHTML = '';
            
            RESOURCE_DB.forEach(section => {
                const title = document.createElement('div');
                title.className = 'section-title';
                title.innerHTML = `<i class="ph-fill ph-circles-four"></i> ${section.title}`;
                grid.appendChild(title);

                const container = document.createElement('div');
                container.className = 'source-grid';
                
                section.sources.forEach(src => {
                    const card = document.createElement('div');
                    card.className = 'source-card';
                    // æ ¹æ®æ ‡ç­¾ä¸åŒæ˜¾ç¤ºä¸åŒå›¾æ ‡
                    let iconClass = "ph-television";
                    if(src.tag.includes("å½±è§†")) iconClass = "ph-film-strip";
                    if(src.tag.includes("å¬ä¹¦")) iconClass = "ph-radio";
                    
                    card.innerHTML = `
                        <div class="s-icon"><i class="ph-fill ${iconClass}"></i></div>
                        <div class="s-content">
                            <h4>${src.name}</h4>
                            <p>${src.desc}</p>
                            <span class="tag">${src.tag}</span>
                        </div>
                    `;
                    card.onclick = () => loadSource(src);
                    container.appendChild(card);
                });
                grid.appendChild(container);
            });
        }

        // åŠ è½½æº (æ™ºèƒ½ä»£ç† + M3Uè§£æ)
        async function loadSource(source) {
            toggleModal(false);
            document.getElementById('current-source-label').innerText = source.name;
            document.getElementById('group-list').innerHTML = '<div style="padding:30px;text-align:center;color:#666"><i class="ph ph-spinner ph-spin" style="font-size:24px;"></i><br>æ­£åœ¨åŠ è½½èµ„æº...</div>';
            document.getElementById('channel-list').innerHTML = '';

            try {
                let url = source.url;
                // æ™ºèƒ½ä»£ç†é€»è¾‘ï¼šå¦‚æœæ˜¯Github/Gitee rawé“¾æ¥ï¼Œèµ°ä»£ç†
                if (url.includes('githubusercontent') || url.includes('gitee.com')) {
                    // å¦‚æœé“¾æ¥é‡Œå·²ç»åŒ…å«äº†ä»£ç†(ghproxy)ï¼Œå°±ä¸åŠ äº†ï¼Œå¦åˆ™åŠ  CORS_PROXY
                    if (!url.includes('ghproxy')) {
                        url = CORS_PROXY + url;
                    }
                }

                const res = await fetch(url);
                const text = await res.text();
                
                parseM3u(text);
                renderGroups();
                
            } catch (e) {
                console.error(e);
                document.getElementById('group-list').innerHTML = `<div style="padding:20px;text-align:center;color:#ff453a"><i class="ph-fill ph-warning-circle"></i><br>åŠ è½½å¤±è´¥<br><span style="font-size:10px">è¯·æ£€æŸ¥ç½‘ç»œæˆ–æºåœ°å€</span></div>`;
            }
        }

        // è§£æ M3U
        function parseM3u(content) {
            allChannels = [];
            const lines = content.split('\n');
            let info = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.startsWith('#EXTINF')) {
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const nameParts = line.split(',');
                    const name = nameParts[nameParts.length-1].trim();
                    const group = groupMatch ? groupMatch[1] : 'å…¶ä»–';
                    const logo = logoMatch ? logoMatch[1] : '';
                    info = { name, group, logo };
                } else if (!line.startsWith('#') && info) {
                    allChannels.push({ ...info, url: line });
                    info = null;
                }
            });
        }

        // æ¸²æŸ“åˆ†ç»„
        function renderGroups() {
            const groups = {};
            allChannels.forEach(ch => { groups[ch.group] = (groups[ch.group] || 0) + 1; });
            const list = document.getElementById('group-list');
            list.innerHTML = `<div class="group-label">æ‰€æœ‰é¢‘é“ (${allChannels.length})</div>`;

            // å…¨éƒ¨
            renderGroupBtn("å…¨éƒ¨", allChannels.length, list);

            // çƒ­é—¨åˆ†ç»„ç½®é¡¶é€»è¾‘ (å¯é€‰)
            Object.keys(groups).sort().forEach(g => {
                renderGroupBtn(g, groups[g], list);
            });
            
            selectGroup("å…¨éƒ¨");
        }

        function renderGroupBtn(name, count, parent) {
            const div = document.createElement('div');
            div.className = 'group-item';
            div.innerHTML = `<span>${name}</span><span class="badge">${count}</span>`;
            div.onclick = (e) => {
                document.querySelectorAll('.group-item').forEach(i => i.classList.remove('active'));
                e.currentTarget.classList.add('active');
                selectGroup(name);
            };
            if(name === 'å…¨éƒ¨') div.classList.add('active');
            parent.appendChild(div);
        }

        function selectGroup(groupName) {
            currentGroup = groupName;
            const filtered = groupName === 'å…¨éƒ¨' ? allChannels : allChannels.filter(ch => ch.group === groupName);
            renderChannels(filtered);
            document.getElementById('search-input').value = ''; // æ¸…ç©ºæœç´¢
        }

        // æ¸²æŸ“é¢‘é“åˆ—è¡¨ (å¸¦æ‡’åŠ è½½ä¼˜åŒ–)
        function renderChannels(channels) {
            const container = document.getElementById('channel-list');
            container.innerHTML = '';
            
            // é™åˆ¶æ¸²æŸ“æ•°é‡é˜²æ­¢å¡é¡¿ (å‰150ä¸ª)
            const limit = 150;
            const list = channels.slice(0, limit);

            if(list.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">æš‚æ— é¢‘é“</div>';
                return;
            }

            list.forEach(ch => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                // é»˜è®¤å›¾æ ‡
                const logo = ch.logo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjIiPjxyZWN0IHg9IjIiIHk9IjYiIHdpZHRoPSIyMCIgaGVpZ2h0PSIxMiIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PC9zdmc+';
                
                card.innerHTML = `
                    <img class="ch-logo" src="${logo}" onerror="this.src='${logo}'">
                    <div class="ch-info">
                        <div class="ch-name">${ch.name}</div>
                        <div class="ch-epg">${ch.group}</div>
                    </div>
                `;
                card.onclick = () => {
                    document.querySelectorAll('.channel-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    play(ch.url);
                };
                container.appendChild(card);
            });

            if (channels.length > limit) {
                const more = document.createElement('div');
                more.style.padding = '15px'; more.style.textAlign = 'center'; more.style.fontSize='12px'; more.style.color='#666';
                more.innerHTML = `ä»…æ˜¾ç¤ºå‰ ${limit} ä¸ªï¼Œè¯·ä½¿ç”¨ä¸Šæ–¹æœç´¢æŸ¥æ‰¾æ›´å¤š`;
                container.appendChild(more);
            }
        }

        // æœç´¢åŠŸèƒ½
        function handleSearch() {
            const val = document.getElementById('search-input').value.toLowerCase();
            if(!val) {
                selectGroup(currentGroup);
                return;
            }
            const res = allChannels.filter(ch => ch.name.toLowerCase().includes(val));
            renderChannels(res);
        }

        // æ’­æ”¾æ§åˆ¶
        function play(url) {
            document.getElementById('standby-screen').style.display = 'none';
            if (!player) {
                player = new Player({
                    id: 'player', url, playsinline: true, autoplay: true, fluid: true,
                    plugins: [window.HlsJsPlugin], cssFullscreen: true, width:'100%', height:'100%'
                });
                player.once('play', () => player.getCssFullscreen());
            } else {
                player.src = url; player.reload(); player.play();
            }
        }

        // UI è¾…åŠ©
        function toggleStandby() {
            const el = document.getElementById('standby-screen');
            el.style.display = el.style.display === 'none' ? 'flex' : 'none';
        }
        function toggleModal(show) {
            document.getElementById('modal-overlay').style.display = show ? 'flex' : 'none';
        }
        function handleModalClick(e) {
            if (e.target.id === 'modal-overlay') toggleModal(false);
        }

        // æ‰‹æœºç«¯
        function initPhone() {
            document.getElementById('phone-remote').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('middle-panel').style.display = 'none';
            document.getElementById('stage').style.display = 'none';
            
            client = mqtt.connect(mqttBroker);
            client.on('connect', () => document.getElementById('phone-status').innerText = 'âœ… å·²è¿æ¥åˆ°è½¦è¾†');
            
            window.sendVideo = () => {
                const url = document.getElementById('urlInput').value.trim();
                if(url) { client.publish(topic, url); alert('æŒ‡ä»¤å·²å‘é€'); }
            }
        }
    </script>
</body>
</html>
