<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tesla Cinema</title>
    <style>
        /* --- 1. 特斯拉暗黑风格 UI --- */
        body { margin: 0; padding: 0; background-color: #121212; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }
        
        /* 布局容器 */
        #app { display: flex; flex-direction: column; height: 100vh; }

        /* 顶部搜索栏 */
        .header { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; align-items: center; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: #fff; font-size: 16px; outline: none; }
        button { padding: 10px 20px; border-radius: 8px; border: none; background: #E50914; color: #fff; font-weight: bold; cursor: pointer; }
        button:active { opacity: 0.8; }

        /* 内容区域 (滚动) */
        .content { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
        
        /* 海报网格 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .card { background: #1e1e1e; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .poster { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #333; }
        .title { padding: 8px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* 播放器层 (覆盖全屏) */
        #player-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none; flex-direction: column;
        }
        
        /* 播放器 Iframe */
        .iframe-box { flex: 1; width: 100%; position: relative; }
        iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* 选集控制栏 */
        .controls { height: 30%; background: #121212; padding: 15px; overflow-y: auto; border-top: 1px solid #333; }
        .episode-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .ep-btn { 
            padding: 8px 15px; background: #2c2c2c; border-radius: 4px; font-size: 14px; 
            cursor: pointer; border: 1px solid #333; min-width: 60px; text-align: center;
        }
        .ep-btn.active { background: #E50914; border-color: #E50914; }
        
        /* 关闭按钮 */
        .close-btn { 
            position: absolute; top: 15px; left: 15px; z-index: 200; 
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.3); font-size: 12px;
        }

        /* 加载中提示 */
        .loading { text-align: center; padding: 20px; color: #666; display: none; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <input type="text" id="searchInput" placeholder="搜电影、电视剧..." value="庆余年">
        <button onclick="doSearch()">搜索</button>
    </div>

    <div class="content">
        <div id="loading" class="loading">正在连接资源库...</div>
        <div id="videoGrid" class="grid"></div>
    </div>
</div>

<div id="player-layer">
    <div class="close-btn" onclick="closePlayer()">← 返回搜索</div>
    <div class="iframe-box">
        <iframe id="playFrame" src="" allow="autoplay; encrypted-media; fullscreen" scrolling="no"></iframe>
    </div>
    <div class="controls">
        <h3 id="playTitle" style="margin-top:0; font-size:16px;">选集</h3>
        <div id="episodes" class="episode-list"></div>
    </div>
</div>

<script>
    // --- 配置区 ---
    // 你的资源 API (JSON 接口)
    const API_BASE = "https://hhzyapi.com/api.php/provide/vod/";
    // 你的解析器地址 (支持 iframe 的那个)
    const PARSER_URL = "https://hhjiexi.com/play/?url=";

    // --- 核心逻辑 ---

    // 1. 搜索功能
    async function doSearch() {
        const wd = document.getElementById('searchInput').value;
        if(!wd) return alert("请输入关键词");

        const grid = document.getElementById('videoGrid');
        const loader = document.getElementById('loading');
        
        grid.innerHTML = '';
        loader.style.display = 'block';

        try {
            // 直接调用 API 搜索 (ac=detail 才能直接拿到播放链接)
            const res = await fetch(`${API_BASE}?ac=detail&wd=${encodeURIComponent(wd)}`);
            const data = await res.json();
            
            loader.style.display = 'none';

            if (!data.list || data.list.length === 0) {
                grid.innerHTML = '<div style="width:100%;text-align:center;color:#666">未找到相关影片</div>';
                return;
            }

            // 渲染海报墙
            data.list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openPlayer(item);
                card.innerHTML = `
                    <img class="poster" src="${item.vod_pic}" onerror="this.src='https://via.placeholder.com/150x200?text=No+Image'">
                    <div class="title">${item.vod_name}</div>
                `;
                grid.appendChild(card);
            });

        } catch (e) {
            loader.style.display = 'none';
            alert("搜索失败：API 可能有跨域限制，请查看下方说明。\n" + e.message);
        }
    }

    // 2. 打开播放器
    function openPlayer(videoData) {
        document.getElementById('player-layer').style.display = 'flex';
        document.getElementById('playTitle').innerText = videoData.vod_name + " - 正在播放";
        
        // 解析播放列表字符串
        // 格式通常是: "第01集$http://...#第02集$http://..."
        // 有些资源站有多个线路，我们取 "hhm3u8" 或第一个
        const playUrlStr = videoData.vod_play_url; 
        const episodesDiv = document.getElementById('episodes');
        episodesDiv.innerHTML = '';

        // 简单处理：假设只有一个播放组，或者都混合在一起
        // 如果有多个分隔符 $$$，通常代表多条线路，这里简化处理取第一条
        let listStr = playUrlStr.split('$$$')[0]; 
        
        const epList = listStr.split('#').filter(s => s.includes('$'));

        epList.forEach(ep => {
            const [name, url] = ep.split('$');
            const btn = document.createElement('div');
            btn.className = 'ep-btn';
            btn.innerText = name;
            btn.onclick = () => {
                // 移除其他高亮
                document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                playVideo(url);
            };
            episodesDiv.appendChild(btn);
        });

        // 自动播放第一集
        if(epList.length > 0) {
            episodesDiv.firstChild.click();
        }
    }

    // 3. 执行播放
    function playVideo(m3u8Url) {
        const frame = document.getElementById('playFrame');
        // 拼接解析地址
        frame.src = PARSER_URL + m3u8Url;
    }

    // 4. 关闭播放器
    function closePlayer() {
        document.getElementById('player-layer').style.display = 'none';
        document.getElementById('playFrame').src = ""; // 停止播放
    }

    // 页面加载自动搜一下热门
    window.onload = () => {
        document.getElementById('searchInput').value = '热门';
        doSearch();
    }
</script>

</body>
</html>
