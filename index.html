<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ç‰¹æ–¯æ‹‰é‡‘é¹°è§‚å½±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: sans-serif; padding: 20px; }
        .title { font-size: 22px; margin-bottom: 20px; text-align: center; }
        /* æœç´¢æ¡†ï¼ˆç‰¹æ–¯æ‹‰è§¦æ§ä¼˜åŒ–ï¼‰ */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        #searchInput { 
            flex: 1; 
            padding: 12px 15px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            background: #111; 
            color: #fff; 
            font-size: 16px; 
            height: 48px;
        }
        #searchBtn { 
            padding: 0 20px; 
            border: none; 
            border-radius: 8px; 
            background: #0071e3; 
            color: #fff; 
            font-size: 16px; 
            cursor: pointer; 
            height: 48px;
        }
        /* åˆ†ç±»æ ‡ç­¾ï¼ˆå¯¹é½é‡‘é¹°æ¥å£type_nameï¼‰ */
        .category-tabs { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .category-tab { padding: 8px 15px; background: #111; border: 1px solid #333; border-radius: 20px; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .category-tab.active { background: #0071e3; border-color: #0071e3; }
        /* è§†é¢‘åˆ—è¡¨ï¼ˆç‰¹æ–¯æ‹‰è§¦æ§å‹å¥½ï¼‰ */
        .video-list { margin-bottom: 30px; }
        .video-item { 
            background: #111; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            touch-action: manipulation;
        }
        .video-title { font-size: 18px; margin-bottom: 5px; }
        .video-info { font-size: 14px; color: #999; display: flex; justify-content: space-between; }
        /* æ’­æ”¾å™¨åŒºåŸŸ */
        #dplayer { width: 100vw; height: 100vh; display: none; position: fixed; top: 0; left: 0; z-index: 999; background: #000; }
        .loading-tips { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 18px; z-index: 9999; display: none; }
        .back-btn { 
            position: fixed; 
            top: 20px; 
            left: 20px; 
            z-index: 1000; 
            background: rgba(0,0,0,0.8); 
            color: #fff; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: none;
        }
        .error-tips { text-align: center; color: #ff4444; font-size: 16px; margin-top: 20px; display: none; }
    </style>
</head>
<body>
    <h1 class="title">ç‰¹æ–¯æ‹‰é‡‘é¹°è§‚å½±</h1>
    <!-- æœç´¢æ¡† -->
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="è¾“å…¥å½±ç‰‡åç§°æœç´¢ï¼ˆå¦‚ï¼šå¼€æ‹“è€…VSçˆµå£«ï¼‰">
        <button id="searchBtn">æœç´¢</button>
    </div>
    <!-- åˆ†ç±»æ ‡ç­¾ï¼ˆå®Œå…¨å¯¹é½é‡‘é¹°æ¥å£è¿”å›çš„type_nameï¼‰ -->
    <div class="category-tabs" id="categoryTabs">
        <div class="category-tab active" data-type="all">å…¨éƒ¨</div>
        <div class="category-tab" data-type="ç¯®çƒ">ç¯®çƒ</div>
        <div class="category-tab" data-type="è¶³çƒ">è¶³çƒ</div>
        <div class="category-tab" data-type="æ—¥æœ¬åŠ¨æ¼«">æ—¥æœ¬åŠ¨æ¼«</div>
        <div class="category-tab" data-type="çŸ­å‰§">çŸ­å‰§</div>
        <div class="category-tab" data-type="å‰§æƒ…ç‰‡">å‰§æƒ…ç‰‡</div>
        <div class="category-tab" data-type="ç»¼è‰º">ç»¼è‰º</div>
        <div class="category-tab" data-type="æ—¥å‰§">æ—¥å‰§</div>
    </div>
    <!-- è§†é¢‘åˆ—è¡¨ -->
    <div class="loading-tips" id="listLoading">æ­£åœ¨åŠ è½½è§†é¢‘åˆ—è¡¨...</div>
    <div class="error-tips" id="listError">åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</div>
    <div class="video-list" id="videoList"></div>

    <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
    <button class="back-btn" id="backBtn" onclick="backToList()">è¿”å›åˆ—è¡¨</button>
    <div class="loading-tips" id="playLoading">æ­£åœ¨è§£ææ’­æ”¾...</div>
    <div id="dplayer"></div>

    <script src="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>

    <script>
        // é‡‘é¹°èµ„æºæ¥å£é…ç½®ï¼ˆæ ¸å¿ƒï¼‰
        const CONFIG = {
            proxy: "https://api.allorigins.win/get?url=", // CORSè·¨åŸŸä»£ç†
            collectApi: "https://jyzyapi.com/provide/vod/from/jinyingm3u8/at/json", // è§†é¢‘åˆ—è¡¨æ¥å£
            detailApi: "https://jyzyapi.com/provide/vod/from/jinyingm3u8/at/json?ac=detail&ids=", // è§†é¢‘è¯¦æƒ…ï¼ˆè·å–æ’­æ”¾åœ°å€ï¼‰
            parseApi: "https://hd.iapijy.com/play?url=", // M3U8è§£ææ¥å£
            backupCollectApi: "http://jyzyapi.com/provide/vod/from/jinyingm3u8/at/json" // å¤‡ç”¨åˆ—è¡¨æ¥å£ï¼ˆå»æ‰sï¼‰
        };

        let dp = null; // æ’­æ”¾å™¨å®ä¾‹
        let allVideos = []; // æ‰€æœ‰è§†é¢‘æ•°æ®
        let currentType = 'all'; // å½“å‰é€‰ä¸­åˆ†ç±»

        // ğŸ”¥ æ ¸å¿ƒï¼šç‰¹æ–¯æ‹‰DæŒ¡ç»•è¿‡é€»è¾‘ï¼ˆè¡Œé©¶ä¸­ä¸æš‚åœï¼‰
        function bypassTeslaDRestriction() {
            // æ‹¦æˆªè§†é¢‘pauseäº‹ä»¶ï¼Œå¼ºåˆ¶æ’­æ”¾
            document.addEventListener('pause', function(e) {
                if (e.target.tagName === 'VIDEO' && window.navigator.userAgent.includes('Tesla')) {
                    e.preventDefault();
                    e.target.play();
                }
            }, true);
            // é€‚é…ç‰¹æ–¯æ‹‰è§†é¢‘æ’­æ”¾è§„åˆ™
            const video = document.createElement('video');
            video.setAttribute('playsinline', 'true');
            video.setAttribute('webkit-playsinline', 'true');
        }

        // é‡‡é›†è§†é¢‘åˆ—è¡¨ï¼ˆé€šè¿‡CORSä»£ç†ï¼Œå…¼å®¹HTTPS/HTTPï¼‰
        async function collectVideos() {
            document.getElementById('listLoading').style.display = 'block';
            document.getElementById('videoList').style.display = 'none';
            document.getElementById('listError').style.display = 'none';

            try {
                // ä¼˜å…ˆè°ƒç”¨HTTPSæ¥å£
                let response = await fetch(CONFIG.proxy + encodeURIComponent(CONFIG.collectApi), { timeout: 15000 });
                if (!response.ok) throw new Error('HTTPSé‡‡é›†å¤±è´¥ï¼Œåˆ‡æ¢HTTP');
                
                let data = await response.json();
                let parsedData = JSON.parse(data.contents); // è§£æä»£ç†è¿”å›çš„å†…å®¹
                if (!parsedData.list || parsedData.list.length === 0) throw new Error('æ— æ•°æ®ï¼Œåˆ‡æ¢å¤‡ç”¨æ¥å£');

                allVideos = parsedData.list;
                renderVideoList(currentType); // æ¸²æŸ“å½“å‰åˆ†ç±»è§†é¢‘
            } catch (e) {
                // åˆ‡æ¢å¤‡ç”¨HTTPæ¥å£
                try {
                    const backupResponse = await fetch(CONFIG.proxy + encodeURIComponent(CONFIG.backupCollectApi), { timeout: 15000 });
                    const backupData = await backupResponse.json();
                    const parsedBackupData = JSON.parse(backupData.contents);
                    if (!parsedBackupData.list || parsedBackupData.list.length === 0) throw new Error('å¤‡ç”¨æ¥å£æ— æ•°æ®');

                    allVideos = parsedBackupData.list;
                    renderVideoList(currentType);
                } catch (backupErr) {
                    document.getElementById('listLoading').style.display = 'none';
                    document.getElementById('listError').style.display = 'block';
                    console.log('é‡‡é›†æŠ¥é”™ï¼š', backupErr);
                }
            }
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç±»+æœç´¢ï¼‰
        function renderVideoList(type, searchKeyword = '') {
            document.getElementById('listLoading').style.display = 'none';
            const list = document.getElementById('videoList');
            list.innerHTML = "";

            // 1. æŒ‰åˆ†ç±»è¿‡æ»¤ï¼ˆä¸¥æ ¼å¯¹é½æ¥å£type_nameï¼‰
            let filteredVideos = type === 'all' 
                ? allVideos 
                : allVideos.filter(video => video.type_name === type);

            // 2. æŒ‰æœç´¢å…³é”®è¯è¿‡æ»¤ï¼ˆæ¨¡ç³ŠåŒ¹é…+å¤§å°å†™ä¸æ•æ„Ÿï¼‰
            if (searchKeyword) {
                filteredVideos = filteredVideos.filter(video => 
                    video.vod_name.toLowerCase().includes(searchKeyword.toLowerCase())
                );
            }

            // æ— ç»“æœæç¤º
            if (filteredVideos.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">è¯¥åˆ†ç±»æš‚æ— è§†é¢‘æˆ–æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                list.style.display = 'block';
                return;
            }

            // æ¸²æŸ“è§†é¢‘é¡¹
            filteredVideos.forEach(video => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'video-item';
                itemDiv.onclick = () => playVideo(video.vod_id, video.vod_name); // ç‚¹å‡»æ’­æ”¾

                const title = document.createElement('div');
                title.className = 'video-title';
                title.innerText = video.vod_name;

                const info = document.createElement('div');
                info.className = 'video-info';
                info.innerText = `${video.type_name} | ${video.vod_remarks || 'æ­£ç‰‡'}`;

                itemDiv.appendChild(title);
                itemDiv.appendChild(info);
                list.appendChild(itemDiv);
            });

            list.style.display = 'block';
        }

        // è§£æå¹¶æ’­æ”¾è§†é¢‘ï¼ˆå…ˆè·å–è¯¦æƒ…æ¥å£çš„çœŸå®æ’­æ”¾åœ°å€ï¼‰
        async function playVideo(vodId, vodName) {
            document.getElementById('playLoading').style.display = 'block';
            document.getElementById('videoList').style.display = 'none';
            document.getElementById('dplayer').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';

            // åˆå§‹åŒ–DæŒ¡ç»•è¿‡é€»è¾‘
            bypassTeslaDRestriction();

            try {
                // 1. è°ƒç”¨è¯¦æƒ…æ¥å£è·å–çœŸå®æ’­æ”¾åœ°å€ï¼ˆåˆ—è¡¨æ¥å£vod_play_urlä¸ºç©ºï¼‰
                const detailUrl = CONFIG.detailApi + vodId;
                const detailResponse = await fetch(CONFIG.proxy + encodeURIComponent(detailUrl), { timeout: 15000 });
                const detailData = await detailResponse.json();
                const parsedDetailData = JSON.parse(detailData.contents);
                const playUrl = parsedDetailData.list[0].vod_play_url.split("$")[1] || "";

                if (!playUrl) throw new Error('æœªè·å–åˆ°æ’­æ”¾åœ°å€');

                // 2. æ‹¼æ¥è§£ææ¥å£åœ°å€
                const parseUrl = CONFIG.parseApi + encodeURIComponent(playUrl);
                
                // 3. åˆå§‹åŒ–æ’­æ”¾å™¨
                if (dp) dp.destroy(); // é”€æ¯æ—§æ’­æ”¾å™¨
                dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    autoplay: true,
                    muted: true,
                    preload: 'auto',
                    volume: 0.7,
                    video: { url: parseUrl, type: 'hls' },
                    danmaku: false,
                    pluginOptions: {
                        hls: { maxBufferLength: 60, maxMaxBufferLength: 90, startLevel: 0, lowLatencyMode: true }
                    }
                });

                // åŠ è½½å®Œæˆéšè—æç¤º
                dp.on('ready', () => { document.getElementById('playLoading').style.display = 'none'; });
                // æ’­æ”¾é”™è¯¯å¤„ç†
                dp.on('error', () => {
                    document.getElementById('playLoading').style.display = 'none';
                    alert(`ã€Š${vodName}ã€‹æ’­æ”¾å¤±è´¥ï¼Œå¯æ¢å…¶ä»–è§†é¢‘è¯•è¯•`);
                    backToList();
                });
            } catch (e) {
                document.getElementById('playLoading').style.display = 'none';
                alert('è§£æå¤±è´¥ï¼š' + e.message);
                backToList();
            }
        }

        // è¿”å›è§†é¢‘åˆ—è¡¨
        function backToList() {
            if (dp) dp.destroy(); // é”€æ¯æ’­æ”¾å™¨
            document.getElementById('dplayer').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('playLoading').style.display = 'none';
            document.getElementById('videoList').style.display = 'block';
        }

        // ç»‘å®šåˆ†ç±»æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        function bindCategoryTabs() {
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // æ›´æ–°å½“å‰åˆ†ç±»å¹¶é‡æ–°æ¸²æŸ“
                    currentType = tab.dataset.type;
                    renderVideoList(currentType);
                    // æ¸…ç©ºæœç´¢æ¡†
                    document.getElementById('searchInput').value = '';
                });
            });
        }

        // ç»‘å®šæœç´¢äº‹ä»¶ï¼ˆç‚¹å‡»/å›è½¦ï¼‰
        function bindSearch() {
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');

            const doSearch = () => {
                const keyword = searchInput.value.trim();
                renderVideoList(currentType, keyword); // åœ¨å½“å‰åˆ†ç±»ä¸‹æœç´¢
            };

            searchBtn.addEventListener('click', doSearch);
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') doSearch();
            });
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = () => {
            bindCategoryTabs(); // ç»‘å®šåˆ†ç±»åˆ‡æ¢
            bindSearch(); // ç»‘å®šæœç´¢
            collectVideos(); // åŠ è½½è§†é¢‘åˆ—è¡¨
            // åŠ è½½å¤±è´¥é‡è¯•
            document.getElementById('listError').addEventListener('click', collectVideos);
        };
    </script>
</body>
</html>
