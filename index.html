<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>特斯拉副驾观影</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; height: 100vh; overflow: hidden; font-family: sans-serif; }
        #dplayer { width: 100vw; height: 100vh; }
        /* 特斯拉触控优化：放大控制按钮 */
        .dplayer-icon { transform: scale(1.2); margin: 0 8px; cursor: pointer; }
        .dplayer-bar { height: 8px !important; }
        .dplayer-thumb { width: 20px !important; height: 20px !important; }
        /* 核心：隐藏video标签的原生特征，规避特斯拉检测 */
        video { 
            -webkit-touch-callout: none; 
            pointer-events: auto !important; 
            user-select: none;
            playsinline: true;
            webkit-playsinline: true;
        }
        .loading-tips { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 18px; z-index: 9999; }
        .error-tips { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #ff4444; padding: 20px; border-radius: 8px; font-size: 16px; z-index: 9999; max-width: 80%; text-align: center; }
    </style>
</head>
<body>
    <div class="loading-tips" id="loadingTips">正在初始化播放器...</div>
    <div id="dplayer"></div>

    <script src="https://cdn.jsdelivr.net/npm/dplayer@latest/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>

    <script>
        // 隐藏加载提示
        function hideLoadingTips() { document.getElementById('loadingTips').style.display = 'none'; }

        // 显示错误提示
        function showErrorTips(msg) {
            hideLoadingTips();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-tips';
            errorDiv.innerHTML = msg;
            document.body.appendChild(errorDiv);
        }

        // 从URL获取M3U8视频源
        function getVideoUrl() {
            const urlParams = window.location.href.split("url=");
            if (urlParams.length < 2) return null;
            const videoUrl = decodeURIComponent(urlParams[1]);
            if (!videoUrl.includes('.m3u8')) return null;
            return videoUrl;
        }

        // 核心：绕过特斯拉挂D挡的视频暂停限制
        function bypassTeslaDRestriction() {
            // 1. 捕获阶段拦截pause事件（优先级高于特斯拉监听）
            document.addEventListener('pause', function(e) {
                // 仅针对特斯拉车机的video标签
                if (e.target.tagName === 'VIDEO' && window.navigator.userAgent.includes('Tesla')) {
                    e.preventDefault(); // 阻止特斯拉的pause指令生效
                    e.target.play();    // 强制恢复播放，抵消D挡限制
                }
            }, true);

            // 2. 禁用特斯拉对video的自动暂停策略
            document.addEventListener('webkitvisibilitychange', function(e) {
                if (document.webkitHidden && e.target.tagName === 'VIDEO') {
                    e.preventDefault();
                }
            }, true);

            // 3. 强制内联播放，规避全屏检测
            const video = document.createElement('video');
            video.setAttribute('playsinline', 'true');
            video.setAttribute('webkit-playsinline', 'true');
            video.setAttribute('x5-playsinline', 'true');
        }

        // 初始化播放器
        function initPlayer() {
            // 先执行D挡限制绕过逻辑
            bypassTeslaDRestriction();

            // 获取视频源
            const videoUrl = getVideoUrl();
            if (!videoUrl) {
                showErrorTips('未检测到有效视频源！<br>请从搜索页选择视频，或拼接URL：?url=你的M3U8地址');
                return;
            }

            try {
                const dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    autoplay: true,       // 自动播放（静音状态下特斯拉允许）
                    muted: true,          // 核心：静音自动播放，避开D挡的交互限制
                    preload: 'auto',      // 预加载，避免D挡后加载中断
                    volume: 0.7,          // 默认音量70%（用户可手动调）
                    video: {
                        url: videoUrl,
                        type: 'hls'        // 适配M3U8格式
                    },
                    danmaku: false,       // 关闭弹幕，减少资源占用
                    // HLS优化：提升D挡下的播放流畅度
                    pluginOptions: {
                        hls: {
                            maxBufferLength: 60,
                            maxMaxBufferLength: 90,
                            startLevel: 0,
                            lowLatencyMode: true,
                            enableWorker: true
                        }
                    },
                    // 特斯拉触控优化
                    controlBar: {
                        volume: { size: '24px' },
                        progress: { height: '8px' },
                        playButton: { size: '36px' }
                    }
                });

                // 播放器就绪后隐藏加载提示
                dp.on('ready', hideLoadingTips);

                // 播放错误处理
                dp.on('error', () => showErrorTips('视频加载失败！<br>检查视频源：<br>' + videoUrl));

                // 特斯拉交互：点击屏幕唤醒控制栏
                dp.on('click', () => dp.showControl());

            } catch (e) {
                showErrorTips('播放器初始化失败：<br>' + e.message);
            }
        }

        // 延迟初始化，适配特斯拉车机加载节奏
        window.onload = () => setTimeout(initPlayer, 300);
    </script>
</body>
</html>
