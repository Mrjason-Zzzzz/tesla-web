<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tesla D-Gear Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 基础设置 --- */
        :root { --bg: #000; --side: #121212; --accent: #E50914; --text: #fff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; }

        /* --- 布局修复 (Flexbox) --- */
        .app { display: flex; width: 100vw; height: 100vh; }
        
        /* 左侧侧边栏 (固定宽度) */
        .sidebar { 
            width: 80px; 
            background: var(--side); 
            border-right: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; 
            padding-top: 30px; 
            flex-shrink: 0; /* 禁止压缩 */
            z-index: 20;
        }
        
        /* 右侧主内容 (自动填充剩余空间) */
        .main { 
            flex: 1; 
            position: relative; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            background: #000;
        }

        /* 侧边栏按钮 */
        .btn { width: 50px; height: 50px; margin-bottom: 20px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .btn i { font-size: 24px; margin-bottom: 5px; }
        .btn.active { background: #333; color: var(--accent); }

        /* --- 播放器区域 (Canvas核心) --- */
        .player-container {
            flex: 1;
            position: relative;
            background: #000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* 1. 幽灵视频源 (负责声音+解码) */
        /* 关键：必须可见(opacity!=0)，但极小，且层级最低 */
        #ghost-video {
            position: absolute; top: 0; left: 0;
            width: 10px; height: 10px;
            opacity: 0.01; 
            z-index: 1;
            pointer-events: none;
        }

        /* 2. 镜像画布 (负责D档画面) */
        /* 关键：层级高，浏览器认为它是图片，不拦截 */
        #mirror-canvas {
            width: 100%; height: 100%;
            object-fit: contain;
            z-index: 2;
        }

        /* 3. D档覆盖层 (强制全屏) */
        .app.drive-mode .sidebar { display: none; }
        .app.drive-mode .main { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; }
        .app.drive-mode #mirror-canvas { width: 100vw; height: 100vh; background: #000; }

        /* 控制按钮 */
        .controls {
            position: absolute; bottom: 30px; right: 30px; z-index: 100;
            display: flex; gap: 15px;
        }
        
        .action-btn {
            background: rgba(50, 50, 50, 0.8);
            border: 1px solid #555;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(5px);
        }
        .action-btn.red { background: var(--accent); border: none; box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4); }

        /* 调试信息 */
        .debug-info {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,0.5); padding: 10px;
            color: lime; font-family: monospace; font-size: 12px;
            pointer-events: none; z-index: 50;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="app" id="app">
    <div class="sidebar">
        <div class="btn active"><i class="fas fa-play-circle"></i>测试</div>
        <div class="btn"><i class="fas fa-cog"></i>设置</div>
    </div>

    <div class="main">
        <div class="debug-info" id="debug">等待加载...</div>

        <div class="player-container">
            <video id="ghost-video" playsinline webkit-playsinline crossorigin="anonymous"></video>
            
            <canvas id="mirror-canvas"></canvas>
        </div>

        <div class="controls">
            <button class="action-btn" onclick="location.reload()"><i class="fas fa-sync"></i> 刷新</button>
            <button class="action-btn red" id="drive-btn" onclick="toggleDriveMode()">
                <i class="fas fa-car"></i> 开启 D档模式
            </button>
        </div>
    </div>
</div>

<script>
    // --- 配置 ---
    // 你提供的测试地址
    const TEST_URL = "https://vod.360zyx.vip/20251018/eT501sKw/index.m3u8";
    
    // --- 变量 ---
    const video = document.getElementById('ghost-video');
    const canvas = document.getElementById('mirror-canvas');
    const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
    const debug = document.getElementById('debug');
    let isDrive = false;
    let renderId;

    // --- 初始化 ---
    window.onload = () => {
        log("初始化播放器...");
        initPlayer();
        initCanvasLoop();
        
        // 5秒后自动尝试播放，应对自动播放策略
        setTimeout(() => {
            if(video.paused) {
                video.play().then(()=>log("自动播放成功")).catch(()=>log("请点击屏幕任意位置开始播放"));
            }
        }, 2000);
    };

    // 点击屏幕强制开始 (解决浏览器的 User Activation 限制)
    document.body.addEventListener('click', () => {
        if(video.paused) {
            video.play();
            log("用户触发播放");
        }
    }, { once: true });

    // --- 1. 视频加载逻辑 ---
    function initPlayer() {
        if (Hls.isSupported()) {
            const hls = new Hls({
                enableWorker: true,
                // 关键：允许跨域，否则Canvas画不出来
                xhrSetup: function(xhr, url) { xhr.withCredentials = false; }
            });
            hls.loadSource(TEST_URL);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                log("视频源加载完毕，准备播放");
                video.play().catch(e => log("等待交互以播放..."));
            });
            hls.on(Hls.Events.ERROR, (e, data) => {
                if(data.fatal) log("HLS错误: " + data.type);
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = TEST_URL;
            video.play();
        }
    }

    // --- 2. Canvas 渲染循环 (D档核心) ---
    function initCanvasLoop() {
        const render = () => {
            if (!video.paused && !video.ended) {
                // 将视频画面画到 Canvas 上
                // 只要这一步成功，D档就能看到画面
                try {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                } catch(e) {
                    // 如果报错，通常是跨域问题
                    // log("绘图失败: " + e.message); 
                }
            }
            requestAnimationFrame(render);
        };
        requestAnimationFrame(render);

        // 监听视频尺寸变化
        video.addEventListener('loadedmetadata', () => {
            log(`分辨率: ${video.videoWidth}x${video.videoHeight}`);
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
        });

        // 监听播放状态
        video.addEventListener('play', () => log("状态: 播放中 (声音+Canvas)"));
        video.addEventListener('pause', () => log("状态: 暂停"));
    }

    // --- 3. D档模式切换 ---
    function toggleDriveMode() {
        isDrive = !isDrive;
        const app = document.getElementById('app');
        const btn = document.getElementById('drive-btn');

        if(isDrive) {
            app.classList.add('drive-mode');
            btn.innerHTML = '<i class="fas fa-compress"></i> 退出 D档';
            log("已进入行车模式：Canvas强制全屏");
            // 强制重置画布尺寸以适应全屏
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        } else {
            app.classList.remove('drive-mode');
            btn.innerHTML = '<i class="fas fa-car"></i> 开启 D档模式';
            log("已退出行车模式");
        }
    }

    // --- 辅助日志 ---
    function log(msg) {
        debug.innerText = msg + "\n" + debug.innerText;
        console.log(msg);
    }
</script>
</body>
</html>
