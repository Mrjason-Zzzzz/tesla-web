<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LGCXS è½¦è½½æŠ•å±</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="//unpkg.com/xgplayer@2.31.6/browser/index.js"></script>
    <script src="//unpkg.com/xgplayer-hls.js/dist/index.min.js"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ç•Œé¢é€šç”¨ */
        .container { text-align: center; width: 90%; max-width: 400px; }
        h2 { margin-bottom: 10px; font-weight: normal; }
        .status { font-size: 12px; color: #aaa; margin-top: 10px; }
        
        /* è½¦æœºç«¯ï¼šäºŒç»´ç  */
        #car-ui { display: none; }
        #qrcode { background: #fff; padding: 10px; border-radius: 8px; display: inline-block; }
        
        /* æ‰‹æœºç«¯ï¼šé¥æ§å™¨ */
        #phone-ui { display: none; background: #222; padding: 20px; border-radius: 12px; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: none; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #07c160; color: #fff; border: none; border-radius: 6px; font-size: 16px; }
        
        /* æ’­æ”¾å™¨ (é»˜è®¤éšè—ï¼Œæ¥æ”¶åˆ°ä¿¡å·åå…¨å±) */
        #player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: none; background: #000; }
        
        /* å¼ºåˆ¶ç½‘é¡µå…¨å± (ç»•è¿‡è½¦æœºé™åˆ¶) */
        .xgplayer-is-cssfullscreen {
            position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important;
        }
    </style>
</head>
<body>

    <div id="player"></div>

    <div id="car-ui" class="container">
        <div id="qrcode"></div>
        <h2>æ‰‹æœºæ‰«ç æŠ•é€</h2>
        <div class="status" id="car-status">æ­£åœ¨è¿æ¥å…¬å…±ä¿¡å·å¡”...</div>
    </div>

    <div id="phone-ui" class="container">
        <h2>ç²˜è´´è§†é¢‘é“¾æ¥</h2>
        <input type="text" id="urlInput" placeholder="åœ¨æ­¤ç²˜è´´ m3u8 æˆ– mp4 é“¾æ¥">
        <button onclick="sendVideo()">ç«‹å³æŠ•å±</button>
        <div class="status" id="phone-status">å‡†å¤‡å°±ç»ª</div>
    </div>

    <script>
        // === é…ç½®ï¼šä½¿ç”¨å…è´¹çš„å…¬å…± MQTT Broker ===
        // è¿™é‡Œä½¿ç”¨çš„æ˜¯ EMQX çš„å…è´¹å…¬å…±æœåŠ¡å™¨ï¼Œæ”¯æŒ WebSocket SSL
        const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
        
        // ç”Ÿæˆä¸€ä¸ªéšæœºçš„é€šä¿¡é¢‘é“ IDï¼Œé˜²æ­¢è·Ÿåˆ«äººä¸²å°
        const getUuid = () => Math.random().toString(36).substring(2, 9);
        
        // æ ¸å¿ƒé€»è¾‘
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode'); // 'sender' æ˜¯æ‰‹æœº, null æ˜¯è½¦æœº
        const channelId = params.get('id') || getUuid(); // é€šä¿¡é¢‘é“ID
        const topic = `lgcxs/car/${channelId}`; // MQTT è®¢é˜…çš„ä¸»é¢˜

        let client = null;

        if (mode === 'sender') {
            initPhone();
        } else {
            initCar();
        }

        // =======================
        // ğŸš— è½¦æœºç«¯é€»è¾‘
        // =======================
        function initCar() {
            document.getElementById('car-ui').style.display = 'block';
            
            // 1. ç”ŸæˆäºŒç»´ç  (æŒ‡å‘æ‰‹æœºé¥æ§é¡µé¢)
            const remoteUrl = `${window.location.origin}${window.location.pathname}?mode=sender&id=${channelId}`;
            new QRCode(document.getElementById("qrcode"), { text: remoteUrl, width: 200, height: 200 });

            // 2. è¿æ¥ MQTT
            client = mqtt.connect(mqttBroker);
            
            client.on('connect', () => {
                document.getElementById('car-status').innerText = 'âœ… ä¿¡å·å·²è¿æ¥ï¼Œç­‰å¾…æ‰«ç ...';
                client.subscribe(topic); // ç›‘å¬è¿™ä¸ªé¢‘é“
            });

            // 3. æ”¶åˆ°æ¶ˆæ¯ -> æ’­æ”¾
            client.on('message', (topic, message) => {
                const videoUrl = message.toString();
                console.log('æ”¶åˆ°è§†é¢‘:', videoUrl);
                startPlayer(videoUrl);
            });
        }

        // å¯åŠ¨æ’­æ”¾å™¨
        function startPlayer(url) {
            document.getElementById('car-ui').style.display = 'none';
            document.getElementById('player').style.display = 'block';
            
            // å¦‚æœå·²æœ‰æ’­æ”¾å™¨åˆ™é”€æ¯é‡å»º (é¿å…æ—§æµç¼“å­˜)
            document.getElementById('player').innerHTML = '';
            
            const player = new Player({
                id: 'player',
                url: url,
                playsinline: true,      // å…³é”®ï¼šè½¦æœºé˜²å±è”½
                autoplay: true,
                fluid: true,
                plugins: [window.HlsJsPlugin], // æ”¯æŒ m3u8
                cssFullscreen: true     // ç½‘é¡µæ ·å¼å…¨å±
            });
            
            player.once('play', () => {
                // å°è¯•è‡ªåŠ¨è¿›å…¥ç½‘é¡µå…¨å±
                player.getCssFullscreen();
            });
        }

        // =======================
        // ğŸ“± æ‰‹æœºç«¯é€»è¾‘
        // =======================
        function initPhone() {
            document.getElementById('phone-ui').style.display = 'block';
            
            client = mqtt.connect(mqttBroker);
            
            client.on('connect', () => {
                document.getElementById('phone-status').innerText = 'âœ… å·²è¿æ¥åˆ°è½¦æœº';
            });
        }

        window.sendVideo = function() {
            const url = document.getElementById('urlInput').value.trim();
            if(!url) return alert('è¯·ç²˜è´´é“¾æ¥');
            
            if(client && client.connected) {
                // å‘é€æ¶ˆæ¯åˆ°é‚£ä¸ªé¢‘é“
                client.publish(topic, url);
                alert('å·²å‘é€æŒ‡ä»¤ï¼');
            } else {
                alert('è¿æ¥ä¸­ï¼Œè¯·ç¨å...');
            }
        }
    </script>
</body>
</html>
