<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è½¦è½½ç”µè§† Ultimate</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="//unpkg.com/xgplayer@2.31.6/browser/index.js"></script>
    <script src="//unpkg.com/xgplayer-hls.js/dist/index.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; }
        
        /* ä¾§è¾¹æ ï¼šåˆ†ç»„+é¢‘é“ */
        #sidebar { width: 220px; height: 100%; background: #1a1a1a; display: flex; flex-direction: column; border-right: 1px solid #333; z-index: 20; }
        
        /* åˆ†ç»„æ ‡ç­¾æ  */
        #group-tabs { display: flex; overflow-x: auto; background: #222; padding: 5px; border-bottom: 1px solid #333; height: 40px; align-items: center; }
        .group-tab { padding: 5px 10px; margin-right: 5px; font-size: 12px; white-space: nowrap; cursor: pointer; color: #888; border-radius: 4px; }
        .group-tab.active { background: #e50914; color: #fff; }
        
        /* é¢‘é“åˆ—è¡¨ */
        #channel-list { flex: 1; overflow-y: auto; padding: 10px; }
        .channel-item { padding: 10px; margin-bottom: 5px; background: #2a2a2a; border-radius: 4px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; }
        .channel-item:hover, .channel-item.active { background: #e50914; transform: translateX(5px); }
        .channel-logo { width: 30px; height: 30px; margin-right: 10px; object-fit: contain; border-radius: 4px; background: rgba(255,255,255,0.1); }
        .channel-name { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* åº•éƒ¨å·¥å…· */
        .toolbar { padding: 10px; background: #111; text-align: center; font-size: 12px; color: #666; cursor: pointer; border-top: 1px solid #333; }

        /* æ’­æ”¾åŒº */
        #main { flex: 1; position: relative; }
        #player { width: 100%; height: 100%; }
        
        /* æ‰‹æœºç«¯ */
        #phone-ui { display: none; padding: 20px; background: #fff; height: 100vh; color: #000; }
        
        /* æ‰«ç å±‚ */
        #qr-layer { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:50; }
        #qrcode { background:#fff; padding:15px; border-radius:10px; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) { #sidebar { width: 160px; } }
    </style>
</head>
<body>

    <div id="phone-ui">
        <h3>ğŸ“º è½¦è½½é¥æ§å™¨</h3>
        <input type="text" id="urlInput" placeholder="ç²˜è´´è§†é¢‘é“¾æ¥" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc;">
        <button onclick="sendVideo()" style="width:100%; padding:12px; background:#e50914; color:#fff; border:none;">ç«‹å³æŠ•å±</button>
        <p id="phone-status" style="margin-top:10px; color:green;">è¿æ¥ä¸­...</p>
    </div>

    <div id="sidebar">
        <div id="group-tabs"></div>
        <div id="channel-list"></div>
        <div class="toolbar" onclick="toggleQr()">ğŸ“² æ‰‹æœºæŠ•å± / æ¢æº</div>
    </div>
    
    <div id="main">
        <div id="player"></div>
        <div id="qr-layer">
            <div id="qrcode"></div>
            <div style="margin-top:20px; color:#fff; font-size:14px;">å¾®ä¿¡æ‰«ç  ç²˜è´´é“¾æ¥</div>
            <div style="margin-top:20px; padding:5px 20px; border:1px solid #fff; border-radius:20px; cursor:pointer; color:#fff;" onclick="toggleQr()">å…³é—­</div>
        </div>
    </div>

    <script>
        // ğŸ“¢ é…ç½®åŒºï¼šå¦‚æœä½ æœ‰å…¶ä»–æºï¼Œæ”¹è¿™é‡Œ
        const DEFAULT_SOURCE = 'https://live.fanmingming.com/tv/m3u/ipv6.m3u';
        
        // MQTT é…ç½®
        const mqttBroker = 'wss://broker.emqx.io:8084/mqtt';
        const getUuid = () => Math.random().toString(36).substring(2, 9);
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        const channelId = params.get('id') || getUuid();
        const topic = `lgcxs/car/${channelId}`;
        let client = null, player = null, allData = null;

        if (mode === 'sender') initSender();
        else initCar();

        // === æ ¸å¿ƒé€»è¾‘ï¼šç§»æ¤è‡ª m3u-parser.js ===
        // è¿™é‡Œæˆ‘æŠŠåŸç½‘ç«™çš„è§£æé€»è¾‘ç®€åŒ–å¹¶é›†æˆè¿›æ¥äº†
        function parseM3U(rawText) {
            const lines = rawText.replace(/\r\n?/g, '\n').split('\n');
            const groups = {}; // æŒ‰åˆ†ç»„å­˜å‚¨
            let currentInfo = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('#EXTINF')) {
                    // è§£æå±æ€§
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    const nameParts = line.split(',');
                    const name = nameParts[nameParts.length - 1].trim();
                    const group = groupMatch ? groupMatch[1] : 'å…¶ä»–é¢‘é“';
                    const logo = logoMatch ? logoMatch[1] : '';

                    // è¿‡æ»¤é€»è¾‘ï¼šè·³è¿‡â€œæ›´æ–°æ—¶é—´â€ç­‰æ— æ•ˆé¢‘é“
                    if (group.includes('æ›´æ–°æ—¶é—´') || name.includes('åˆ—è¡¨æ›´æ–°')) {
                        currentInfo = null;
                        return;
                    }

                    currentInfo = { name, group, logo };
                } else if (!line.startsWith('#') && currentInfo) {
                    const url = line;
                    if (!groups[currentInfo.group]) groups[currentInfo.group] = [];
                    
                    groups[currentInfo.group].push({
                        name: currentInfo.name,
                        url: url,
                        logo: currentInfo.logo
                    });
                    currentInfo = null;
                }
            });
            return groups;
        }

        // === è½¦æœºç«¯é€»è¾‘ ===
        async function initCar() {
            // ç”ŸæˆäºŒç»´ç 
            const remoteUrl = `${window.location.origin}${window.location.pathname}?mode=sender&id=${channelId}`;
            new QRCode(document.getElementById("qrcode"), { text: remoteUrl, width: 200, height: 200 });

            // ç›‘å¬ MQTT
            client = mqtt.connect(mqttBroker);
            client.on('connect', () => client.subscribe(topic));
            client.on('message', (t, msg) => {
                const url = msg.toString();
                if(url.endsWith('.m3u') || url.endsWith('.m3u8')) {
                    // å¦‚æœæŠ•é€çš„æ˜¯åˆ—è¡¨ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
                    loadSource(url);
                } else {
                    // å¦‚æœæ˜¯å•è§†é¢‘ï¼Œç›´æ¥æ’­æ”¾
                    play(url);
                    toggleQr(false);
                }
            });

            // åŠ è½½é»˜è®¤æº
            loadSource(DEFAULT_SOURCE);
        }

        async function loadSource(url) {
            try {
                document.getElementById('channel-list').innerHTML = '<div style="padding:10px; color:#999;">æ­£åœ¨è§£æåˆ—è¡¨...</div>';
                const res = await fetch(url);
                const text = await res.text();
                allData = parseM3U(text);
                renderGroups();
            } catch (e) {
                alert('æºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }

        function renderGroups() {
            const tabs = document.getElementById('group-tabs');
            tabs.innerHTML = '';
            const groupNames = Object.keys(allData);
            
            if(groupNames.length === 0) return;

            groupNames.forEach((g, index) => {
                const btn = document.createElement('div');
                btn.className = `group-tab ${index === 0 ? 'active' : ''}`;
                btn.innerText = g;
                btn.onclick = () => {
                    document.querySelectorAll('.group-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderChannels(g);
                };
                tabs.appendChild(btn);
            });

            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ç»„
            renderChannels(groupNames[0]);
        }

        function renderChannels(groupName) {
            const list = document.getElementById('channel-list');
            list.innerHTML = '';
            
            allData[groupName].forEach(ch => {
                const div = document.createElement('div');
                div.className = 'channel-item';
                div.innerHTML = `
                    <img class="channel-logo" src="${ch.logo}" onerror="this.style.display='none'">
                    <span class="channel-name">${ch.name}</span>
                `;
                div.onclick = () => {
                    document.querySelectorAll('.channel-item').forEach(i => i.classList.remove('active'));
                    div.classList.add('active');
                    play(ch.url);
                };
                list.appendChild(div);
            });
        }

        function play(url) {
            if (!player) {
                player = new Player({
                    id: 'player',
                    url: url,
                    playsinline: true,
                    autoplay: true,
                    fluid: true,
                    plugins: [window.HlsJsPlugin],
                    cssFullscreen: true // ç½‘é¡µå…¨å±é˜²å±è”½
                });
                player.once('play', () => player.getCssFullscreen());
            } else {
                player.src = url;
                player.reload(); // åˆ‡å°é‡è½½
                player.play();
            }
        }

        function toggleQr(show) {
            const el = document.getElementById('qr-layer');
            el.style.display = (show === undefined ? (el.style.display === 'flex' ? 'none' : 'flex') : (show ? 'flex' : 'none'));
        }

        // === æ‰‹æœºç«¯é€»è¾‘ ===
        function initSender() {
            document.body.style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('main').style.display = 'none';
            document.getElementById('phone-ui').style.display = 'block';
            
            client = mqtt.connect(mqttBroker);
            client.on('connect', () => document.getElementById('phone-status').innerText = 'âœ… å·²è¿æ¥åˆ°è½¦æœº');
            
            window.sendVideo = () => {
                const url = document.getElementById('urlInput').value.trim();
                if(url && client) {
                    client.publish(topic, url);
                    alert('å·²å‘é€');
                }
            }
        }
    </script>
</body>
</html>
