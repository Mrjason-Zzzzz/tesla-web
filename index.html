<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tesla Cinema Ultra</title>
    <style>
        /* --- UI æ ·å¼åŒº --- */
        body { margin: 0; padding: 0; background-color: #121212; color: #fff; font-family: sans-serif; overflow: hidden; }
        #app { display: flex; flex-direction: column; height: 100vh; }

        /* æœç´¢æ  */
        .header { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; z-index: 10; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2c2c2c; color: #fff; font-size: 16px; outline: none; }
        button { padding: 0 20px; border-radius: 8px; border: none; background: #E50914; color: #fff; font-weight: bold; font-size: 15px; }

        /* å†…å®¹åŒº */
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 15px; }
        
        /* å¡ç‰‡ */
        .card { background: #1e1e1e; border-radius: 6px; overflow: hidden; cursor: pointer; }
        .poster { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #333; }
        .title { padding: 8px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* æ’­æ”¾å™¨å±‚ */
        #player-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none; flex-direction: column;
        }
        
        .iframe-box { flex: 1; width: 100%; position: relative; }
        iframe { width: 100%; height: 100%; border: none; display: block; }

        /* æ§åˆ¶åŒº */
        .controls { height: 35%; background: #121212; padding: 15px; overflow-y: auto; border-top: 1px solid #333; }
        
        /* çº¿è·¯åˆ‡æ¢æŒ‰é’®ç»„ */
        .lines-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .line-btn { 
            padding: 6px 12px; background: #333; border-radius: 4px; font-size: 12px; 
            color: #aaa; border: 1px solid #444; cursor: pointer;
        }
        .line-btn.active { background: #E50914; color: #fff; border-color: #E50914; }

        /* é€‰é›†æŒ‰é’® */
        .ep-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .ep-btn { 
            padding: 10px 18px; background: #2c2c2c; border-radius: 4px; font-size: 14px; 
            cursor: pointer; min-width: 50px; text-align: center; border: 1px solid #333;
        }
        .ep-btn.active { background: #fff; color: #000; border-color: #fff; }

        .close-btn { 
            position: absolute; top: 15px; left: 15px; z-index: 200; 
            background: rgba(0,0,0,0.6); padding: 6px 16px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.3); font-size: 13px;
        }
        .loading { text-align: center; padding: 20px; color: #666; display: none; }
        .error-msg { text-align: center; padding: 30px; color: #E50914; font-size: 14px; }
    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <input type="text" id="searchInput" placeholder="æœç‰‡å..." value="åº†ä½™å¹´">
        <button onclick="doSearch()">æœç´¢</button>
    </div>
    <div class="content">
        <div id="loading" class="loading">æ­£åœ¨æœç´¢å…¨ç½‘èµ„æº...</div>
        <div id="videoGrid" class="grid"></div>
    </div>
</div>

<div id="player-layer">
    <div class="close-btn" onclick="closePlayer()">â† è¿”å›</div>
    
    <div class="iframe-box">
        <iframe id="playFrame" src="" allow="autoplay; encrypted-media; fullscreen" scrolling="no"></iframe>
    </div>
    
    <div class="controls">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="playTitle" style="margin:0; font-size:16px;">æ­£åœ¨æ’­æ”¾</h3>
            <span style="font-size:12px; color:#666;">å¦‚æœå¤±è´¥è¯·åˆ‡æ¢çº¿è·¯ ğŸ‘‡</span>
        </div>

        <div id="line-box" class="lines-group"></div>

        <div id="episodes" class="ep-list"></div>
    </div>
</div>

<script>
    // --- 1. å¤šä¸ªå¤‡ç”¨è§£æçº¿è·¯ (è¿™æ˜¯æ•‘å‘½ç¨»è‰) ---
    const PARSERS = [
        { name: "çº¿è·¯1 (æ¨è)", url: "https://hhjiexi.com/play/?url=" },
        { name: "çº¿è·¯2 (å¤‡ç”¨)", url: "https://jx.xmflv.com/?url=" },
        { name: "çº¿è·¯3 (é€šç”¨)", url: "https://jx.aidouer.net/?url=" },
        { name: "çº¿è·¯4 (çº¯å‡€)", url: "https://im1907.top/?jx=" }
    ];

    const API_TARGET = "https://hhzyapi.com/api.php/provide/vod/";
    let currentVideoUrl = ""; // å½“å‰é€‰ä¸­çš„é‚£ä¸€é›†çš„é“¾æ¥

    // --- æœç´¢é€»è¾‘ (ä¿æŒä¸å˜ï¼Œåˆ©ç”¨ AllOrigins) ---
    async function doSearch() {
        const wd = document.getElementById('searchInput').value;
        if(!wd) return;

        const grid = document.getElementById('videoGrid');
        const loader = document.getElementById('loading');
        
        grid.innerHTML = '';
        loader.style.display = 'block';

        try {
            // ä½¿ç”¨å…¬å…±ä»£ç†è¯·æ±‚ API
            const targetUrl = `${API_TARGET}?ac=detail&wd=${encodeURIComponent(wd)}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
            
            const res = await fetch(proxyUrl);
            const data = await res.json();
            
            loader.style.display = 'none';

            if (!data.list || data.list.length === 0) {
                grid.innerHTML = '<div class="error-msg">æœªæ‰¾åˆ°ç›¸å…³èµ„æºï¼Œæ¢ä¸ªè¯è¯•è¯•</div>';
                return;
            }

            data.list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openPlayer(item);
                card.innerHTML = `
                    <img class="poster" src="${item.vod_pic}" onerror="this.src='https://via.placeholder.com/150x200?text=Poster'">
                    <div class="title">${item.vod_name}</div>
                `;
                grid.appendChild(card);
            });

        } catch (e) {
            loader.style.display = 'none';
            grid.innerHTML = `<div class="error-msg">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</div>`;
        }
    }

    // --- æ‰“å¼€æ’­æ”¾å™¨ ---
    function openPlayer(videoData) {
        document.getElementById('player-layer').style.display = 'flex';
        document.getElementById('playTitle').innerText = videoData.vod_name;
        
        // 1. åˆå§‹åŒ–çº¿è·¯æŒ‰é’®
        renderLines();

        // 2. è§£æé€‰é›†åˆ—è¡¨
        const epDiv = document.getElementById('episodes');
        epDiv.innerHTML = '';
        
        // å¤„ç†å¤šç»„èµ„æº ($$$)
        let playUrlStr = videoData.vod_play_url;
        if (playUrlStr.includes('$$$')) {
            playUrlStr = playUrlStr.split('$$$')[0]; // é»˜è®¤å–ç¬¬ä¸€ç»„
        }

        const epList = playUrlStr.split('#').filter(s => s.includes('$'));

        if(epList.length === 0) {
            epDiv.innerHTML = '<div style="color:#666;padding:10px">æ— æ’­æ”¾èµ„æº</div>';
            return;
        }

        epList.forEach(ep => {
            const [name, url] = ep.split('$');
            const btn = document.createElement('div');
            btn.className = 'ep-btn';
            btn.innerText = name;
            btn.onclick = () => {
                // é€‰ä¸­é›†æ•°
                document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // è®°å½•å½“å‰è§†é¢‘åœ°å€ï¼Œå¹¶è°ƒç”¨å½“å‰çº¿è·¯æ’­æ”¾
                currentVideoUrl = url;
                playWithCurrentLine();
            };
            epDiv.appendChild(btn);
        });

        // è‡ªåŠ¨æ’­æ”¾ç¬¬1é›†
        if(epList.length > 0) {
            epDiv.firstChild.click();
        }
    }

    // --- æ¸²æŸ“çº¿è·¯æŒ‰é’® ---
    let currentLineIndex = 0; // é»˜è®¤ç”¨ç¬¬1æ¡

    function renderLines() {
        const box = document.getElementById('line-box');
        box.innerHTML = '';
        
        PARSERS.forEach((parser, index) => {
            const btn = document.createElement('div');
            btn.className = `line-btn ${index === currentLineIndex ? 'active' : ''}`;
            btn.innerText = parser.name;
            btn.onclick = () => {
                currentLineIndex = index;
                renderLines(); // åˆ·æ–°æŒ‰é’®çŠ¶æ€
                playWithCurrentLine(); // ç«‹å³ç”¨æ–°çº¿è·¯æ’­æ”¾
            };
            box.appendChild(btn);
        });
    }

    // --- æ‰§è¡Œæ’­æ”¾ ---
    function playWithCurrentLine() {
        if (!currentVideoUrl) return;
        
        const frame = document.getElementById('playFrame');
        const parserPrefix = PARSERS[currentLineIndex].url;
        
        // æ‹¼æ¥ï¼šè§£ææ¥å£ + è§†é¢‘åœ°å€
        frame.src = parserPrefix + currentVideoUrl;
        
        console.log("æ­£åœ¨ä½¿ç”¨çº¿è·¯:", PARSERS[currentLineIndex].name, "æ’­æ”¾:", currentVideoUrl);
    }

    function closePlayer() {
        document.getElementById('player-layer').style.display = 'none';
        document.getElementById('playFrame').src = "";
    }

    // é¡µé¢åŠ è½½
    window.onload = () => {
        document.getElementById('searchInput').value = 'çƒ­é—¨';
        doSearch();
    }
</script>

</body>
</html>
